# Multi-App Multi-Tenant RBAC Model
#
# Architecture:
# - DB owns user→role mapping (user_role_assignments table)
# - Casbin owns role→permission evaluation
#
# Request format: (sub, role, app, tenant, obj, act, resourceOwnerId)
# - sub: user ID (for audit and owner conditions)
# - role: resolved from DB lookup, NOT from Casbin g()
#
# Policy format: (role, app, tenant, obj, act, eft, condition)
#
# Role inheritance: g(child_role, parent_role) - optional
#
# Conditions:
# - "" (empty): no condition, always applies
# - "owner": isOwner(sub, resourceOwnerId) must be true
#
# ============================================================================
# ABAC Extension Point (for future use)
# ============================================================================
#
# When ABAC (Attribute-Based Access Control) is needed, extend as follows:
#
# 1. Add resourceAttrs to request definition:
#    r = sub, role, app, tenant, obj, act, resourceOwnerId, resourceAttrs
#
# 2. Add attrCondition to policy definition:
#    p = role, app, tenant, obj, act, eft, condition, attrCondition
#
# 3. Update matcher to evaluate attrCondition:
#    (p.attrCondition == "" ||
#     (p.attrCondition == "published" && r.resourceAttrs.status == "published") ||
#     (p.attrCondition == "draft" && r.resourceAttrs.status == "draft"))
#
# Example use cases this enables:
# - "Viewers can only see published documents"
# - "Free tier users limited to 10 items" (pass count in resourceAttrs)
# - "Only during business hours" (pass current time in resourceAttrs)
#
# The authorize() signature would change to:
#   authorize(userId, orgId, resource, action, resourceOwnerId?, resourceAttrs?)
#
# ============================================================================

[request_definition]
r = sub, role, app, tenant, obj, act, resourceOwnerId

[policy_definition]
p = role, app, tenant, obj, act, eft, condition

[role_definition]
g = _, _

[policy_effect]
e = some(where (p.eft == allow)) && !some(where (p.eft == deny))

[matchers]
m = (r.role == p.role || g(r.role, p.role)) && \
    r.app == p.app && \
    r.tenant == p.tenant && \
    r.obj == p.obj && \
    r.act == p.act && \
    (p.condition == "" || \
     (p.condition == "owner" && isOwner(r.sub, r.resourceOwnerId)))
