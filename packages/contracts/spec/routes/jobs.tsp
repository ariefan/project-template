/**
 * ============================================================================
 * JOBS ROUTES - Async Operation Status
 * ============================================================================
 *
 * Track status of long-running async operations.
 *
 * @see docs/api-guide/05-advanced-operations/
 * ============================================================================
 */

import "@typespec/http";
import "../common/responses.tsp";
import "../common/errors.tsp";
import "../models/job.tsp";

using TypeSpec.Http;

namespace ProjectAPI;

/**
 * Jobs API
 *
 * Unified async job management with pg-boss queue.
 * Supports all job types: reports, imports, exports, etc.
 */
@route("/v1/orgs/{orgId}/jobs")
@tag("Jobs")
interface Jobs {
  /**
   * List async jobs
   *
   * Returns jobs for the current tenant with optional filtering.
   */
  @get
  @summary("List jobs")
  list(
    /** Organization ID */
    @path orgId: string,

    /** Page number (1-indexed) */
    @query page?: int32 = 1,

    /** Number of items per page */
    @query pageSize?: int32 = 50,

    /** Filter by job status */
    @query status?: JobStatus,

    /** Filter by job type (e.g., "report", "import") */
    @query type?: string,

    /** Filter by format (for report jobs) */
    @query format?: string,

    /** Filter by template ID (for report jobs) */
    @query templateId?: string,

    /** Filter jobs created after this timestamp */
    @query createdAfter?: utcDateTime,

    /** Filter jobs created before this timestamp */
    @query createdBefore?: utcDateTime
  ): JobListResponse | ErrorResponse;

  /**
   * Create a new job
   *
   * Creates and enqueues a job for async processing.
   * The job type must have a registered handler.
   */
  @post
  @summary("Create job")
  create(
    /** Organization ID */
    @path orgId: string,

    /** Job creation request */
    @body body: CreateJobRequest
  ): JobResponse | ErrorResponse;

  /**
   * Get job status
   *
   * Poll this endpoint to check progress of async operations.
   */
  @route("/{jobId}")
  @get
  @summary("Get job status")
  get(
    /** Organization ID */
    @path orgId: string,

    /** Job ID */
    @path jobId: string
  ): JobResponse | ErrorResponse;

  /**
   * Cancel a job
   *
   * Only pending or processing jobs can be cancelled.
   */
  @route("/{jobId}/cancel")
  @post
  @summary("Cancel job")
  cancel(
    /** Organization ID */
    @path orgId: string,

    /** Job ID */
    @path jobId: string
  ): JobResponse | ErrorResponse;

  /**
   * Retry a failed job
   *
   * Creates a new job with the same parameters as the failed job.
   */
  @route("/{jobId}/retry")
  @post
  @summary("Retry job")
  retry(
    /** Organization ID */
    @path orgId: string,

    /** Job ID */
    @path jobId: string
  ): JobResponse | ErrorResponse;

  /**
   * Download job result
   *
   * Downloads the file generated by a completed job (e.g., report exports).
   * Only available for jobs that produce downloadable files.
   */
  @route("/{jobId}/download")
  @get
  @summary("Download job result")
  download(
    /** Organization ID */
    @path orgId: string,

    /** Job ID */
    @path jobId: string
  ): bytes | ErrorResponse;
}

/**
 * Job Types API
 *
 * List available job types with their metadata for building
 * schedule configuration forms.
 */
@route("/v1/job-types")
@tag("Jobs")
interface JobTypes {
  /**
   * List available job types
   *
   * Returns all registered job handlers with their metadata
   * for building schedule configuration forms.
   */
  @get
  @summary("List job types")
  list(): JobTypesListResponse | ErrorResponse;
}

