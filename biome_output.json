{
  "summary": {
    "changed": 0,
    "unchanged": 1,
    "matches": 0,
    "duration": { "secs": 0, "nanos": 34082400 },
    "scannerDuration": { "secs": 0, "nanos": 8232700 },
    "errors": 2,
    "warnings": 3,
    "infos": 0,
    "skipped": 0,
    "suggestedFixesSkipped": 0,
    "diagnosticsNotPrinted": 0
  },
  "diagnostics": [
    {
      "category": "suppressions/unused",
      "severity": "warning",
      "description": "Suppression comment has no effect. Remove the suppression or make sure you are suppressing the correct rule.",
      "message": [
        {
          "elements": [],
          "content": "Suppression comment has no effect. Remove the suppression or make sure you are suppressing the correct rule."
        }
      ],
      "advices": { "advices": [] },
      "verboseAdvices": { "advices": [] },
      "location": {
        "path": {
          "file": "packages\\ui\\src\\composed\\file-upload\\image-uploader.tsx"
        },
        "span": [9701, 9823],
        "sourceCode": "\"use client\";\n\n\nimport {\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselNext,\n  CarouselPrevious,\n} from \"@workspace/ui/components/carousel\";\nimport { cn } from \"@workspace/ui/lib/utils\";\n\nimport {\n  ChevronDown,\n  ChevronRight,\n  Crop,\n  Download,\n  Eye,\n  FileImage,\n  Loader2,\n  MoreVertical,\n  Plus,\n  Sparkles,\n  Upload,\n  X,\n} from \"lucide-react\";\nimport * as React from \"react\";\nimport { toast } from \"sonner\";\nimport { Badge } from \"../../components/badge\";\nimport { Button } from \"../../components/button\";\nimport { Checkbox } from \"../../components/checkbox\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"../../components/dropdown-menu\";\nimport { Label } from \"../../components/label\";\nimport { Slider } from \"../../components/slider\";\nimport { ConfirmDialog } from \"../confirm-dialog\"; // Import ConfirmDialog\nimport { FilePreviewDialog } from \"../file-preview/file-preview-dialog\";\nimport { DropzonePrimitive } from \"./dropzone-primitive\";\nimport { type CropResult, ImageCropDialog } from \"./image-crop-dialog\";\n\nexport interface CompressionOptions {\n  maxSizeMB: number;\n  maxWidthOrHeight: number;\n  useWebWorker: boolean;\n  alwaysKeepResolution: boolean;\n}\n\nexport interface CompressedFileWithPreview extends File {\n  originalSize: number;\n  compressedSize: number;\n  preview?: string;\n}\n\n/**\n * Pre-loaded image URL for edit mode display\n */\nexport interface InitialUrl {\n  id: string;\n  url: string;\n  name?: string;\n}\n\ntype CombinedItem =\n  | { type: \"url\"; id: string | number; data: InitialUrl }\n  | { type: \"file\"; id: string | number; data: CompressedFileWithPreview };\n\nexport interface ImageUploaderProps {\n  /**\n   * Callback when files are compressed\n   */\n  onCompressed?: (files: CompressedFileWithPreview[]) => void;\n\n  /**\n   * Callback when upload is requested/confirmed\n   */\n  onConfirm?: (files: CompressedFileWithPreview[]) => void;\n\n  /**\n   * Default compression options\n   */\n  defaultOptions?: Partial<CompressionOptions>;\n\n  /**\n   * Show upload/confirm button after compression\n   */\n  showConfirmButton?: boolean;\n  /**\n   * Show compression options UI\n   * @default false\n   */\n  showCompressionOptions?: boolean;\n\n  /**\n   * Enable cropping by default\n   * @default false\n   */\n  enableCropping?: boolean;\n\n  /**\n   * Automatically upload after compression (if cropping is disabled)\n   * @default false\n   */\n  autoUpload?: boolean;\n\n  /**\n   * Is currently uploading\n   */\n  isUploading?: boolean;\n\n  className?: string;\n  showCompressionDetails?: boolean;\n  /**\n   * Pre-loaded image URLs for edit mode (display-only with remove)\n   */\n  initialUrls?: InitialUrl[];\n\n  /**\n   * Callback when a pre-loaded URL is removed\n   */\n  onRemoveUrl?: (id: string) => void;\n\n  /**\n   * Layout mode for displaying images\n   * @default \"grid\"\n   */\n  layout?: \"grid\" | \"carousel\";\n}\n\n// Format bytes to human readable\nfunction formatBytes(bytes: number): string {\n  if (bytes === 0) {\n    return \"0 B\";\n  }\n  const k = 1024;\n  const sizes = [\"B\", \"KB\", \"MB\", \"GB\"];\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n  return `${Number.parseFloat((bytes / k ** i).toFixed(1))} ${sizes[i]}`;\n}\n\nexport interface ImageUploaderRef {\n  addFiles: (files: File[]) => void;\n  clearFiles: () => void;\n}\n\ninterface CompressionOptionsPanelProps {\n  isOpen: boolean;\n  onOpenChange: (open: boolean) => void;\n  enableCropping: boolean;\n  onEnableCroppingChange: (enabled: boolean) => void;\n  options: CompressionOptions;\n  onOptionsChange: (options: CompressionOptions) => void;\n}\n\nfunction CompressionOptionsPanel({\n  isOpen,\n  onOpenChange,\n  enableCropping,\n  onEnableCroppingChange,\n  options,\n  onOptionsChange,\n}: CompressionOptionsPanelProps) {\n  return (\n    <div className=\"rounded-lg border bg-muted/30 p-4\">\n      <button\n        className=\"flex w-full items-center justify-between font-medium text-sm\"\n        onClick={() => onOpenChange(!isOpen)}\n        type=\"button\"\n      >\n        <span>Compression Options</span>\n        {isOpen ? (\n          <ChevronDown className=\"h-4 w-4\" />\n        ) : (\n          <ChevronRight className=\"h-4 w-4\" />\n        )}\n      </button>\n\n      {isOpen && (\n        <div className=\"mt-4 space-y-4\">\n          {/* Enable cropping toggle */}\n          <div className=\"flex items-center gap-3 rounded-lg border border-primary/20 bg-primary/5 p-3\">\n            <Sparkles className=\"h-5 w-5 text-primary\" />\n            <div className=\"flex flex-1 flex-col gap-1\">\n              <Label className=\"cursor-pointer\" htmlFor=\"enable-cropping\">\n                Enable image cropping\n              </Label>\n              <p className=\"text-muted-foreground text-xs\">\n                Crop, rotate, and flip images before compression\n              </p>\n            </div>\n            <Checkbox\n              checked={enableCropping}\n              id=\"enable-cropping\"\n              onCheckedChange={(checked: boolean) =>\n                onEnableCroppingChange(checked)\n              }\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center justify-between\">\n              <Label htmlFor=\"maxSizeMB\">Max file size (MB)</Label>\n              <span className=\"text-muted-foreground text-sm\">\n                {options.maxSizeMB} MB\n              </span>\n            </div>\n            <Slider\n              id=\"maxSizeMB\"\n              max={10}\n              min={0.1}\n              onValueChange={([value]: number[]) => {\n                if (value !== undefined) {\n                  onOptionsChange({\n                    ...options,\n                    maxSizeMB: value,\n                  });\n                }\n              }}\n              step={0.1}\n              value={[options.maxSizeMB]}\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center justify-between\">\n              <Label htmlFor=\"maxDimension\">Max width/height (px)</Label>\n              <span className=\"text-muted-foreground text-sm\">\n                {options.maxWidthOrHeight} px\n              </span>\n            </div>\n            <Slider\n              id=\"maxDimension\"\n              max={4096}\n              min={480}\n              onValueChange={([value]: number[]) => {\n                if (value !== undefined) {\n                  onOptionsChange({\n                    ...options,\n                    maxWidthOrHeight: value,\n                  });\n                }\n              }}\n              step={32}\n              value={[options.maxWidthOrHeight]}\n            />\n          </div>\n\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center gap-3\">\n              <Checkbox\n                checked={options.useWebWorker}\n                onCheckedChange={(checked: boolean) =>\n                  onOptionsChange({\n                    ...options,\n                    useWebWorker: checked,\n                  })\n                }\n              />\n              <Label className=\"cursor-pointer\">Use Web Worker</Label>\n            </div>\n\n            <div className=\"flex items-center gap-3\">\n              <Checkbox\n                checked={options.alwaysKeepResolution}\n                onCheckedChange={(checked: boolean) =>\n                  onOptionsChange({\n                    ...options,\n                    alwaysKeepResolution: checked,\n                  })\n                }\n              />\n              <Label className=\"cursor-pointer\">Keep resolution</Label>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\ninterface ImageGridListProps {\n  items: CombinedItem[];\n  layout: \"grid\" | \"carousel\";\n  onRemove: (item: CombinedItem) => void;\n  onDownload: (file: CompressedFileWithPreview) => void;\n  onView: (url: string, name: string, type: string) => void;\n  showCompressionDetails: boolean;\n}\n\nfunction ImageGridList({\n  items,\n  layout,\n  onRemove,\n  onDownload,\n  onView,\n  showCompressionDetails,\n}: ImageGridListProps) {\n  const renderItem = (item: CombinedItem) => (\n    <ImageUploaderItem\n      item={item}\n      key={item.id}\n      layout={layout}\n      onDownload={onDownload}\n      onRemove={() => onRemove(item)}\n      onView={onView}\n      showCompressionDetails={showCompressionDetails}\n    />\n  );\n\n  if (layout === \"grid\") {\n    return (\n      <div className=\"grid grid-cols-3 gap-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6\">\n        {items.map((item) => renderItem(item))}\n      </div>\n    );\n  }\n\n  return (\n    <Carousel\n      className=\"mx-auto min-h-[120px] w-full\"\n      opts={{ align: \"start\" }}\n    >\n      <CarouselContent className=\"-ml-2 md:-ml-4\">\n        {items.map((item) => (\n          <CarouselItem className=\"basis-full pl-2 md:pl-4\" key={item.id}>\n            {renderItem(item)}\n          </CarouselItem>\n        ))}\n      </CarouselContent>\n      <CarouselPrevious className=\"left-2 bg-background/80 hover:bg-background\" />\n      <CarouselNext className=\"right-2 bg-background/80 hover:bg-background\" />\n    </Carousel>\n  );\n}\n\nfunction useDragDrop(\n  onFilesSelected: (files: FileList | File[] | null) => void\n) {\n  const [isDragging, setIsDragging] = React.useState(false);\n\n  const handleDragOver = React.useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(true);\n  }, []);\n\n  const handleDragLeave = React.useCallback(() => {\n    setIsDragging(false);\n  }, []);\n\n  const handleDrop = React.useCallback(\n    (e: React.DragEvent) => {\n      e.preventDefault();\n      setIsDragging(false);\n      onFilesSelected(e.dataTransfer.files);\n    },\n    [onFilesSelected]\n  );\n\n  return { isDragging, handleDragOver, handleDragLeave, handleDrop };\n}\n\n// biome-ignore lint/complexity/noExcessiveCognitiveComplexity: Controller manages complex file upload state and workflows\nfunction useImageUploaderController(\n  props: ImageUploaderProps,\n  ref: React.ForwardedRef<ImageUploaderRef>\n) {\n  const {\n    onCompressed,\n    onConfirm,\n    defaultOptions,\n    enableCropping: defaultEnableCropping = false,\n    autoUpload = true,\n    initialUrls,\n  } = props;\n\n  const fileInputRef = React.useRef<HTMLInputElement>(null);\n  const [deleteTarget, setDeleteTarget] = React.useState<{\n    type: \"file\" | \"url\";\n    id: string | number;\n  } | null>(null);\n  const [_sourceFiles, setSourceFiles] = React.useState<File[]>([]);\n  const [compressedFiles, setCompressedFiles] = React.useState<\n    CompressedFileWithPreview[]\n  >([]);\n  const [isCompressing, setIsCompressing] = React.useState(false);\n\n  const [isCompressionOptionsOpen, setIsCompressionOptionsOpen] =\n    React.useState(false);\n  const [compressionOptions, setCompressionOptions] =\n    React.useState<CompressionOptions>({\n      maxSizeMB: defaultOptions?.maxSizeMB ?? 1,\n      maxWidthOrHeight: defaultOptions?.maxWidthOrHeight ?? 1920,\n      useWebWorker: defaultOptions?.useWebWorker ?? true,\n      alwaysKeepResolution: defaultOptions?.alwaysKeepResolution ?? false,\n    });\n\n  // Cropping state\n  const [enableCropping, setEnableCropping] = React.useState(\n    defaultEnableCropping\n  );\n  const [cropDialogOpen, setCropDialogOpen] = React.useState(false);\n  const [fileToCrop, setFileToCrop] = React.useState<File | null>(null);\n  const [cropQueue, setCropQueue] = React.useState<File[]>([]);\n  const [processedCrops, setProcessedCrops] = React.useState<CropResult[]>([]);\n\n  // Preview state\n  const [previewOpen, setPreviewOpen] = React.useState(false);\n  const [previewUrl, setPreviewUrl] = React.useState(\"\");\n  const [previewName, setPreviewName] = React.useState(\"\");\n  const [previewType, setPreviewType] = React.useState(\"\");\n\n  // Dynamically import browser-image-compression to avoid SSR issues\n  const [browserImageCompression, setBrowserImageCompression] = React.useState<\n    typeof import(\"browser-image-compression\").default | null\n  >(null);\n\n  React.useEffect(() => {\n    setEnableCropping(defaultEnableCropping);\n  }, [defaultEnableCropping]);\n\n  React.useEffect(() => {\n    import(\"browser-image-compression\").then((module) => {\n      setBrowserImageCompression(() => module.default);\n    });\n  }, []);\n\n  // Compress a single file\n  const compressSingleFile = React.useCallback(\n    (file: File) => {\n      return compressImageHelper(\n        file,\n        compressionOptions,\n        browserImageCompression\n      );\n    },\n    [browserImageCompression, compressionOptions]\n  );\n\n  // Handle file selection\n  const handleFileSelect = React.useCallback(\n    // biome-ignore lint/complexity/noExcessiveCognitiveComplexity: File selection validation logic is inherently complex\n    (files: FileList | File[] | null, skipCrop = false) => {\n      if (!files) {\n        return;\n      }\n\n      const newFiles = Array.from(files).filter((f) =>\n        f.type.startsWith(\"image/\")\n      );\n\n      if (newFiles.length === 0) {\n        toast.error(\"Please select image files only\");\n        return;\n      }\n\n      if (enableCropping && !skipCrop) {\n        // Add to queue for cropping\n        setCropQueue((prev) => {\n          const existing = prev.map((f) => f.name);\n          const filtered = newFiles.filter((f) => !existing.includes(f.name));\n          return [...prev, ...filtered];\n        });\n\n        // Start cropping if dialog is closed\n        if (!cropDialogOpen && newFiles.length > 0) {\n          setFileToCrop(newFiles[0] ?? null);\n          setCropDialogOpen(true);\n        }\n      } else {\n        // Auto-compress immediately\n        setSourceFiles((prev) => {\n          const existing = prev.map((f) => f.name);\n          const filtered = newFiles.filter((f) => !existing.includes(f.name));\n          return [...prev, ...filtered];\n        });\n\n        if (newFiles.length > 0) {\n          setIsCompressing(true);\n          Promise.all(newFiles.map((file) => compressSingleFile(file)))\n            .then((compressed) => {\n              setCompressedFiles((prev) => {\n                const existingNames = prev.map((f) => f.name);\n                const newCompressed = compressed.filter(\n                  (f) => !existingNames.includes(f.name)\n                );\n\n                const nextFiles = [...prev, ...newCompressed];\n                return nextFiles;\n              });\n\n              if (autoUpload && (!enableCropping || skipCrop)) {\n                setTimeout(() => {\n                  setCompressedFiles((current) => {\n                    onConfirm?.(current);\n                    return current;\n                  });\n                }, 0);\n              }\n\n              const totalOriginal = compressed.reduce(\n                (acc, f) => acc + f.originalSize,\n                0\n              );\n              const totalCompressed = compressed.reduce(\n                (acc, f) => acc + f.compressedSize,\n                0\n              );\n              const saving =\n                ((totalOriginal - totalCompressed) / totalOriginal) * 100;\n\n              toast.success(\n                `Compressed ${compressed.length} image${compressed.length > 1 ? \"s\" : \"\"} - Saved ${saving.toFixed(1)}%`\n              );\n\n              onCompressed?.(compressed);\n            })\n            .catch(() => {\n              toast.error(\"Compression failed\");\n            })\n            .finally(() => {\n              setIsCompressing(false);\n            });\n        }\n      }\n    },\n    [\n      compressSingleFile,\n      cropDialogOpen,\n      enableCropping,\n      onCompressed,\n      autoUpload,\n      onConfirm,\n    ]\n  );\n\n  // biome-ignore lint/complexity/noExcessiveCognitiveComplexity: Complex logic\n  const compressAndUploadCrops = React.useCallback(\n    (allCrops: CropResult[]) => {\n      setIsCompressing(true);\n\n      Promise.all(\n        allCrops.map((cropResult) => {\n          const cropFile = new File([cropResult.blob], cropResult.file.name, {\n            type: cropResult.file.type,\n          });\n          return compressSingleFile(cropFile);\n        })\n      )\n        .then((compressed) => {\n          setCompressedFiles((prev) => {\n            const existingNames = prev.map((f) => f.name);\n            const newCompressed = compressed.filter(\n              (f) => !existingNames.includes(f.name)\n            );\n            return [...prev, ...newCompressed];\n          });\n\n          if (autoUpload) {\n            setTimeout(() => {\n              setCompressedFiles((current) => {\n                onConfirm?.(current);\n                return current;\n              });\n            }, 0);\n          }\n\n          setProcessedCrops([]);\n\n          const totalOriginal = compressed.reduce(\n            (acc, f) => acc + f.originalSize,\n            0\n          );\n          const totalCompressed = compressed.reduce(\n            (acc, f) => acc + f.compressedSize,\n            0\n          );\n          const saving =\n            ((totalOriginal - totalCompressed) / totalOriginal) * 100;\n\n          toast.success(\n            `Processed ${compressed.length} image${compressed.length > 1 ? \"s\" : \"\"} - Saved ${saving.toFixed(1)}%`\n          );\n\n          onCompressed?.(compressed);\n        })\n        .catch(() => {\n          toast.error(\"Compression failed\");\n        })\n        .finally(() => {\n          setIsCompressing(false);\n        });\n    },\n    [compressSingleFile, autoUpload, onConfirm, onCompressed]\n  );\n\n  // Handle crop complete\n  // biome-ignore lint/complexity/noExcessiveCognitiveComplexity: Complex logic\n  const handleCropComplete = React.useCallback(\n\n    (result: CropResult) => {\n      setProcessedCrops((prev) => [...prev, result]);\n      setCropQueue((prev) => prev.filter((f) => f.name !== result.file.name));\n\n      // Process next in queue\n      const remaining = cropQueue.filter((f) => f.name !== result.file.name);\n      if (remaining.length > 0) {\n        setFileToCrop(remaining[0] ?? null);\n        return;\n      }\n\n      setFileToCrop(null);\n      setCropDialogOpen(false);\n\n      // All images cropped, now compress\n      const allCrops = [...processedCrops, result];\n      compressAndUploadCrops(allCrops);\n    },\n    [cropQueue, processedCrops, compressAndUploadCrops]\n  );\n\n  // Handle skip crop\n  const handleSkipCrop = React.useCallback(() => {\n    if (!fileToCrop) {\n      return;\n    }\n\n    // Skip this file and move to next\n    setCropQueue((prev) => prev.filter((f) => f.name !== fileToCrop.name));\n\n    const remaining = cropQueue.filter((f) => f.name !== fileToCrop.name);\n    if (remaining.length > 0) {\n      setFileToCrop(remaining[0] ?? null);\n    } else {\n      setFileToCrop(null);\n      setCropDialogOpen(false);\n    }\n  }, [cropQueue, fileToCrop]);\n\n  // Remove compressed file\n  const removeCompressedFile = React.useCallback((index: number) => {\n    setCompressedFiles((prev) => {\n      const file = prev[index];\n      if (file?.preview) {\n        URL.revokeObjectURL(file.preview);\n      }\n      return prev.filter((_, idx) => idx !== index);\n    });\n  }, []);\n\n  // Download compressed file\n  const downloadFile = React.useCallback((file: CompressedFileWithPreview) => {\n    if (file.preview) {\n      const link = document.createElement(\"a\");\n      link.href = file.preview;\n      link.download = file.name;\n      link.click();\n    }\n  }, []);\n\n  // Clear all\n  const clearAll = React.useCallback(() => {\n    for (const f of compressedFiles) {\n      if (f.preview) {\n        URL.revokeObjectURL(f.preview);\n      }\n    }\n    for (const f of processedCrops) {\n      URL.revokeObjectURL(f.url);\n    }\n    setSourceFiles([]);\n    setCompressedFiles([]);\n    setCropQueue([]);\n    setProcessedCrops([]);\n  }, [compressedFiles, processedCrops]);\n\n  React.useImperativeHandle(ref, () => ({\n    addFiles: (files: File[]) => handleFileSelect(files, true),\n    clearFiles: clearAll,\n  }));\n\n  const { isDragging, handleDragOver, handleDragLeave, handleDrop } =\n    useDragDrop(handleFileSelect);\n\n  // Cleanup previews on unmount\n  React.useEffect(() => {\n    return () => {\n      for (const f of compressedFiles) {\n        if (f.preview) {\n          URL.revokeObjectURL(f.preview);\n        }\n      }\n      for (const f of processedCrops) {\n        URL.revokeObjectURL(f.url);\n      }\n    };\n  }, [compressedFiles, processedCrops]);\n\n  const hasFilesInQueue = cropQueue.length > 0 || processedCrops.length > 0;\n  const totalInQueue = cropQueue.length + processedCrops.length;\n  const hasInitialUrls = initialUrls && initialUrls.length > 0;\n  const hasAnyFiles =\n    compressedFiles.length > 0 || hasFilesInQueue || hasInitialUrls;\n\n  const combinedItems = React.useMemo<CombinedItem[]>(\n    () => [\n      ...(initialUrls || []).map((url) => ({\n        type: \"url\" as const,\n        id: url.id,\n        data: url,\n      })),\n      ...compressedFiles.map((file, index) => ({\n        type: \"file\" as const,\n        id: file.name || index,\n        data: file,\n      })),\n    ],\n    [initialUrls, compressedFiles]\n  );\n\n  return {\n    fileInputRef,\n    deleteTarget,\n    setDeleteTarget,\n    compressedFiles,\n    isCompressing,\n    isDragging,\n    isCompressionOptionsOpen,\n    setIsCompressionOptionsOpen,\n    compressionOptions,\n    setCompressionOptions,\n    enableCropping,\n    setEnableCropping,\n    cropDialogOpen,\n    setCropDialogOpen,\n    fileToCrop,\n    setFileToCrop,\n    cropQueue,\n    processedCrops,\n    previewOpen,\n    setPreviewOpen,\n    previewUrl,\n    setPreviewUrl,\n    previewName,\n    setPreviewName,\n    previewType,\n    setPreviewType,\n    handleFileSelect,\n    handleCropComplete,\n    handleSkipCrop,\n    removeCompressedFile,\n    downloadFile,\n    clearAll,\n    handleDragOver,\n    handleDragLeave,\n    handleDrop,\n    hasFilesInQueue,\n    totalInQueue,\n    hasInitialUrls,\n    hasAnyFiles,\n    combinedItems,\n  };\n}\n\nexport const ImageUploader = React.forwardRef<\n  ImageUploaderRef,\n  ImageUploaderProps\n>((props, ref) => {\n  const {\n    className,\n    showCompressionOptions = false,\n    showCompressionDetails = false,\n    showConfirmButton = true,\n    onConfirm,\n    isUploading = false,\n    initialUrls,\n    onRemoveUrl,\n    layout = \"grid\",\n  } = props;\n\n  const controller = useImageUploaderController(props, ref);\n\n  return (\n    <div className={cn(\"space-y-4\", className)}>\n      {/* Options */}\n      {showCompressionOptions && (\n        <CompressionOptionsPanel\n          enableCropping={controller.enableCropping}\n          isOpen={controller.isCompressionOptionsOpen}\n          onEnableCroppingChange={controller.setEnableCropping}\n          onOpenChange={controller.setIsCompressionOptionsOpen}\n          onOptionsChange={controller.setCompressionOptions}\n          options={controller.compressionOptions}\n        />\n      )}\n\n      {/* File Preview Dialog */}\n      <FilePreviewDialog\n        fileName={controller.previewName}\n        fileType={controller.previewType}\n        fileUrl={controller.previewUrl}\n        onOpenChange={controller.setPreviewOpen}\n        open={controller.previewOpen}\n      />\n\n      {/* Upload Area */}\n      {controller.hasAnyFiles ? (\n        <div className=\"space-y-3\">\n          {/* Crop queue indicator */}\n          {controller.hasFilesInQueue && (\n            <div className=\"flex items-center gap-3 rounded-lg border border-primary/20 bg-primary/5 p-3\">\n              <Crop className=\"h-5 w-5 animate-pulse text-primary\" />\n              <div className=\"flex flex-1 flex-col\">\n                <p className=\"font-medium text-sm\">\n                  Processing {controller.totalInQueue} image\n                  {controller.totalInQueue > 1 ? \"s\" : \"\"}\n                </p>\n                <p className=\"text-muted-foreground text-xs\">\n                  {controller.processedCrops.length} of{\" \"}\n                  {controller.totalInQueue} cropped\n                </p>\n              </div>\n              <Loader2 className=\"h-5 w-5 animate-spin text-primary\" />\n            </div>\n          )}\n\n          {/* Add more files button */}\n          <DropzonePrimitive\n            className=\"py-2\"\n            compact={true}\n            onClick={() => {\n              controller.fileInputRef.current?.click();\n            }}\n            onDragLeave={controller.handleDragLeave}\n            onDragOver={controller.handleDragOver}\n            onDrop={controller.handleDrop}\n            onKeyDown={(e) => {\n              if (e.key === \"Enter\" || e.key === \" \") {\n                e.preventDefault();\n                controller.fileInputRef.current?.click();\n              }\n            }}\n          >\n            <Plus className=\"mr-2 h-4 w-4\" />\n            Add more images\n            <input\n              accept=\"image/*\"\n              className=\"hidden\"\n              multiple\n              onChange={(e) => controller.handleFileSelect(e.target.files)}\n              ref={controller.fileInputRef}\n              type=\"file\"\n            />\n          </DropzonePrimitive>\n\n          {/* Images list (Unified) */}\n          {controller.hasAnyFiles &&\n            (controller.compressedFiles.length > 0 ||\n              controller.hasInitialUrls) && (\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between\">\n                  <h3 className=\"font-medium text-sm\">\n                    Images (\n                    {(initialUrls?.length || 0) +\n                      controller.compressedFiles.length}\n                    )\n                  </h3>\n                  {controller.compressedFiles.length > 0 && (\n                    <Button\n                      className=\"text-muted-foreground text-xs\"\n                      disabled={controller.isCompressing}\n                      onClick={controller.clearAll}\n                      size=\"sm\"\n                      variant=\"ghost\"\n                    >\n                      Clear new\n                    </Button>\n                  )}\n                </div>\n                <ImageGridList\n                  items={controller.combinedItems}\n                  layout={layout}\n                  onDownload={controller.downloadFile}\n                  onRemove={(item) => {\n                    if (item.type === \"url\") {\n                      controller.setDeleteTarget({\n                        type: \"url\",\n                        id: item.id,\n                      });\n                    } else {\n                      // Find index in compressedFiles\n                      const index = controller.compressedFiles.indexOf(\n                        item.data as CompressedFileWithPreview\n                      );\n                      controller.setDeleteTarget({\n                        type: \"file\",\n                        id: index,\n                      });\n                    }\n                  }}\n                  onView={(url, name, type) => {\n                    controller.setPreviewUrl(url);\n                    controller.setPreviewName(name);\n                    controller.setPreviewType(type);\n                    controller.setPreviewOpen(true);\n                  }}\n                  showCompressionDetails={showCompressionDetails}\n                />\n              </div>\n            )}\n\n          {/* Loading state */}\n          {controller.isCompressing && (\n            <div className=\"flex items-center justify-center gap-2 rounded-lg border bg-muted/30 py-4 text-muted-foreground text-sm\">\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\n              Processing images...\n            </div>\n          )}\n\n          {/* Confirm Button */}\n          {showConfirmButton &&\n            onConfirm &&\n            controller.compressedFiles.length > 0 && (\n              <Button\n                className=\"w-full\"\n                disabled={isUploading || controller.isCompressing}\n                onClick={() => onConfirm(controller.compressedFiles)}\n              >\n                {isUploading ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Uploading...\n                  </>\n                ) : (\n                  <>\n                    <Upload className=\"mr-2 h-4 w-4\" />\n                    Confirm Upload ({controller.compressedFiles.length})\n                  </>\n                )}\n              </Button>\n            )}\n        </div>\n      ) : (\n        <DropzonePrimitive\n          className={cn(\n            \"gap-4\",\n            controller.isDragging\n              ? \"border-primary bg-primary/5\"\n              : \"border-muted-foreground/25 hover:border-primary/50 hover:bg-muted/50\"\n          )}\n          compact={false}\n          onClick={() => {\n            controller.fileInputRef.current?.click();\n          }}\n          onDragLeave={controller.handleDragLeave}\n          onDragOver={controller.handleDragOver}\n          onDrop={controller.handleDrop}\n          onKeyDown={(e) => {\n            if (e.key === \"Enter\" || e.key === \" \") {\n              e.preventDefault();\n              controller.fileInputRef.current?.click();\n            }\n          }}\n        >\n          <FileImage className=\"h-10 w-10 text-muted-foreground\" />\n          <div className=\"space-y-1 text-center sm:text-left\">\n            <p className=\"font-medium text-lg\">Drop images here</p>\n            <p className=\"text-muted-foreground text-sm\">or click to browse</p>\n          </div>\n          <input\n            accept=\"image/*\"\n            className=\"hidden\"\n            multiple\n            onChange={(e) => controller.handleFileSelect(e.target.files)}\n            ref={controller.fileInputRef}\n            type=\"file\"\n          />\n        </DropzonePrimitive>\n      )}\n\n      {/* Crop Dialog */}\n      <ImageCropDialog\n        imageFile={controller.fileToCrop}\n        onCropComplete={controller.handleCropComplete}\n        onOpenChange={(open: boolean) => {\n          if (open) {\n            controller.setCropDialogOpen(open);\n          } else {\n            controller.handleSkipCrop();\n          }\n        }}\n        onSelectFile={controller.setFileToCrop}\n        open={controller.cropDialogOpen}\n        queue={controller.cropQueue}\n      />\n\n      <ConfirmDialog\n        description=\"This action cannot be undone.\"\n        onCancel={() => controller.setDeleteTarget(null)}\n        onConfirm={() => {\n          if (controller.deleteTarget?.type === \"file\") {\n            controller.removeCompressedFile(\n              controller.deleteTarget.id as number\n            );\n          } else if (controller.deleteTarget?.type === \"url\") {\n            onRemoveUrl?.(controller.deleteTarget.id as string);\n          }\n          controller.setDeleteTarget(null);\n        }}\n        onOpenChange={(open) => !open && controller.setDeleteTarget(null)}\n        open={!!controller.deleteTarget}\n        title=\"Are you sure?\"\n        variant=\"destructive\"\n      />\n    </div>\n  );\n});\ninterface ImagePreviewCardProps {\n  src: string;\n  alt: string;\n  onView?: () => void;\n  onDownload?: () => void;\n  onRemove?: () => void;\n  children?: React.ReactNode;\n  className?: string;\n}\n\nfunction ImagePreviewCard({\n  src,\n  alt,\n  onView,\n  onDownload,\n  onRemove,\n  children,\n  className,\n}: ImagePreviewCardProps) {\n  const containerRef = React.useRef<HTMLDivElement>(null);\n  const [width, setWidth] = React.useState(0);\n\n  React.useEffect(() => {\n    if (!containerRef.current) {\n      return;\n    }\n    const observer = new ResizeObserver((entries) => {\n      for (const entry of entries) {\n        setWidth(entry.contentRect.width);\n      }\n    });\n    observer.observe(containerRef.current);\n    return () => observer.disconnect();\n  }, []);\n\n  const isSmall = width < 100;\n\n  return (\n    <div\n      className={cn(\n        \"group relative aspect-square overflow-hidden rounded-lg border bg-card\",\n        className\n      )}\n      ref={containerRef}\n    >\n      {/* Thumbnail */}\n      {src ? (\n        // biome-ignore lint/correctness/useImageSize: Dynamic content\n        // biome-ignore lint/performance/noImgElement: Framework-agnostic\n        <img alt={alt} className=\"size-full object-cover\" src={src} />\n      ) : (\n        <div className=\"flex size-full items-center justify-center bg-muted\">\n          <FileImage className=\"h-8 w-8 text-muted-foreground\" />\n        </div>\n      )}\n\n      {/* Overlay on hover */}\n      <div className=\"absolute inset-0 flex flex-col justify-between bg-black/60 p-2 opacity-0 transition-opacity group-hover:opacity-100 data-[state=open]:opacity-100\">\n        {/* Actions at top */}\n        <div className=\"flex justify-end\">\n          {isSmall ? (\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button\n                  className=\"size-6 p-0 text-white hover:bg-white/20 hover:text-white\"\n                  size=\"icon\"\n                  variant=\"ghost\"\n                >\n                  <MoreVertical className=\"size-4\" />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                {onView && (\n                  <DropdownMenuItem onClick={onView}>\n                    <Eye className=\"mr-2 size-4\" /> View\n                  </DropdownMenuItem>\n                )}\n                {onDownload && (\n                  <DropdownMenuItem onClick={onDownload}>\n                    <Download className=\"mr-2 size-4\" /> Download\n                  </DropdownMenuItem>\n                )}\n                {onRemove && (\n                  <DropdownMenuItem\n                    className=\"text-destructive focus:text-destructive\"\n                    onClick={onRemove}\n                  >\n                    <X className=\"mr-2 size-4\" /> Remove\n                  </DropdownMenuItem>\n                )}\n              </DropdownMenuContent>\n            </DropdownMenu>\n          ) : (\n            <div className=\"flex justify-end gap-0.5\">\n              {onView && (\n                <Button\n                  className=\"size-6.5 p-0\"\n                  onClick={onView}\n                  size=\"icon\"\n                  title=\"View\"\n                  variant=\"secondary\"\n                >\n                  <Eye className=\"size-3.5\" />\n                </Button>\n              )}\n              {onDownload && (\n                <Button\n                  className=\"size-6.5 p-0\"\n                  onClick={onDownload}\n                  size=\"icon\"\n                  title=\"Download\"\n                  variant=\"secondary\"\n                >\n                  <Download className=\"size-3.5\" />\n                </Button>\n              )}\n              {onRemove && (\n                <Button\n                  className=\"size-6.5 p-0\"\n                  onClick={onRemove}\n                  size=\"icon\"\n                  title=\"Remove\"\n                  variant=\"destructive\"\n                >\n                  <X className=\"size-3.5\" />\n                </Button>\n              )}\n            </div>\n          )}\n        </div>\n\n        {/* File info at bottom */}\n        {children}\n      </div>\n\n      {/* Filename visible at bottom when not hovering/open */}\n      <div className=\"absolute right-0 bottom-0 left-0 rounded-b-lg bg-gradient-to-t from-black/70 to-transparent p-2 opacity-100 transition-opacity group-hover:opacity-0\">\n        <p className=\"truncate font-medium text-white text-xs\" title={alt}>\n          {alt}\n        </p>\n      </div>\n    </div>\n  );\n}\n\nfunction ImageUploaderItem({\n  item,\n  layout,\n  onDownload,\n  onRemove,\n  onView,\n  showCompressionDetails,\n}: {\n  item: CombinedItem;\n  layout: \"grid\" | \"carousel\";\n  onDownload: (file: CompressedFileWithPreview) => void;\n  onRemove: () => void;\n  onView: (url: string, name: string, type: string) => void;\n  showCompressionDetails: boolean;\n}) {\n  if (item.type === \"url\") {\n    const urlData = item.data as InitialUrl;\n    return (\n      <ImagePreviewCard\n        alt={urlData.name || \"\"}\n        className={layout === \"carousel\" ? \"aspect-video w-full\" : undefined}\n        onDownload={() => window.open(urlData.url, \"_blank\")}\n        onRemove={onRemove}\n        onView={() => onView(urlData.url, urlData.name || \"Preview\", \"image/*\")}\n        src={urlData.url}\n      />\n    );\n  }\n\n  const fileData = item.data as CompressedFileWithPreview;\n  const savings = (\n    ((fileData.originalSize - fileData.compressedSize) /\n      fileData.originalSize) *\n    100\n  ).toFixed(1);\n\n  return (\n    <ImagePreviewCard\n      alt={fileData.name}\n      className={layout === \"carousel\" ? \"aspect-video w-full\" : undefined}\n      onDownload={() => onDownload(fileData)}\n      onRemove={onRemove}\n      onView={\n        fileData.preview\n          ? () => onView(fileData.preview ?? \"\", fileData.name, fileData.type)\n          : undefined\n      }\n      src={fileData.preview || \"\"}\n    >\n      <div className=\"space-y-0.5\">\n        <p className=\"truncate font-medium text-[10px] text-white\">\n          {fileData.name}\n        </p>\n        <div className=\"flex justify-between text-[10px] text-white/80\">\n          <span>{formatBytes(fileData.compressedSize)}</span>\n          {showCompressionDetails && (\n            <Badge\n              className=\"text-xs\"\n              variant={Number.parseFloat(savings) > 0 ? \"default\" : \"secondary\"}\n            >\n              {Number.parseFloat(savings) > 0 ? `-${savings}%` : \"0%\"}\n            </Badge>\n          )}\n        </div>\n      </div>\n    </ImagePreviewCard>\n  );\n}\n\nasync function compressImageHelper(\n  file: File,\n  options: CompressionOptions,\n  // biome-ignore lint/suspicious/noExplicitAny: Dynamic import type is complex\n  browserImageCompression: any\n): Promise<CompressedFileWithPreview> {\n  if (!browserImageCompression) {\n    return Object.assign(file, {\n      originalSize: file.size,\n      compressedSize: file.size,\n      preview: URL.createObjectURL(file),\n    }) as CompressedFileWithPreview;\n  }\n\n  if (!file.type.startsWith(\"image/\")) {\n    return Object.assign(file, {\n      originalSize: file.size,\n      compressedSize: file.size,\n      preview: URL.createObjectURL(file),\n    }) as CompressedFileWithPreview;\n  }\n\n  try {\n    const opts = {\n      maxSizeMB: options.maxSizeMB,\n      maxWidthOrHeight: options.maxWidthOrHeight,\n      useWebWorker: options.useWebWorker,\n      alwaysKeepResolution: options.alwaysKeepResolution,\n    };\n    const blob = await browserImageCompression(file, opts);\n    const preview = URL.createObjectURL(blob);\n    const compressedFile = new window.File([blob], file.name, {\n      type: file.type,\n    }) as CompressedFileWithPreview;\n    compressedFile.originalSize = file.size;\n    compressedFile.compressedSize = compressedFile.size;\n    compressedFile.preview = preview;\n    return compressedFile;\n  } catch (e) {\n    console.error(\"Compression failed for\", file.name, e);\n    return Object.assign(file, {\n      originalSize: file.size,\n      compressedSize: file.size,\n      preview: URL.createObjectURL(file), // Fallback preview\n    }) as CompressedFileWithPreview;\n  }\n}\n"
      },
      "tags": [],
      "source": null
    },
    {
      "category": "suppressions/unused",
      "severity": "warning",
      "description": "Suppression comment has no effect. Remove the suppression or make sure you are suppressing the correct rule.",
      "message": [
        {
          "elements": [],
          "content": "Suppression comment has no effect. Remove the suppression or make sure you are suppressing the correct rule."
        }
      ],
      "advices": { "advices": [] },
      "verboseAdvices": { "advices": [] },
      "location": {
        "path": {
          "file": "packages\\ui\\src\\composed\\file-upload\\image-uploader.tsx"
        },
        "span": [15472, 15549],
        "sourceCode": "\"use client\";\n\n\nimport {\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselNext,\n  CarouselPrevious,\n} from \"@workspace/ui/components/carousel\";\nimport { cn } from \"@workspace/ui/lib/utils\";\n\nimport {\n  ChevronDown,\n  ChevronRight,\n  Crop,\n  Download,\n  Eye,\n  FileImage,\n  Loader2,\n  MoreVertical,\n  Plus,\n  Sparkles,\n  Upload,\n  X,\n} from \"lucide-react\";\nimport * as React from \"react\";\nimport { toast } from \"sonner\";\nimport { Badge } from \"../../components/badge\";\nimport { Button } from \"../../components/button\";\nimport { Checkbox } from \"../../components/checkbox\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"../../components/dropdown-menu\";\nimport { Label } from \"../../components/label\";\nimport { Slider } from \"../../components/slider\";\nimport { ConfirmDialog } from \"../confirm-dialog\"; // Import ConfirmDialog\nimport { FilePreviewDialog } from \"../file-preview/file-preview-dialog\";\nimport { DropzonePrimitive } from \"./dropzone-primitive\";\nimport { type CropResult, ImageCropDialog } from \"./image-crop-dialog\";\n\nexport interface CompressionOptions {\n  maxSizeMB: number;\n  maxWidthOrHeight: number;\n  useWebWorker: boolean;\n  alwaysKeepResolution: boolean;\n}\n\nexport interface CompressedFileWithPreview extends File {\n  originalSize: number;\n  compressedSize: number;\n  preview?: string;\n}\n\n/**\n * Pre-loaded image URL for edit mode display\n */\nexport interface InitialUrl {\n  id: string;\n  url: string;\n  name?: string;\n}\n\ntype CombinedItem =\n  | { type: \"url\"; id: string | number; data: InitialUrl }\n  | { type: \"file\"; id: string | number; data: CompressedFileWithPreview };\n\nexport interface ImageUploaderProps {\n  /**\n   * Callback when files are compressed\n   */\n  onCompressed?: (files: CompressedFileWithPreview[]) => void;\n\n  /**\n   * Callback when upload is requested/confirmed\n   */\n  onConfirm?: (files: CompressedFileWithPreview[]) => void;\n\n  /**\n   * Default compression options\n   */\n  defaultOptions?: Partial<CompressionOptions>;\n\n  /**\n   * Show upload/confirm button after compression\n   */\n  showConfirmButton?: boolean;\n  /**\n   * Show compression options UI\n   * @default false\n   */\n  showCompressionOptions?: boolean;\n\n  /**\n   * Enable cropping by default\n   * @default false\n   */\n  enableCropping?: boolean;\n\n  /**\n   * Automatically upload after compression (if cropping is disabled)\n   * @default false\n   */\n  autoUpload?: boolean;\n\n  /**\n   * Is currently uploading\n   */\n  isUploading?: boolean;\n\n  className?: string;\n  showCompressionDetails?: boolean;\n  /**\n   * Pre-loaded image URLs for edit mode (display-only with remove)\n   */\n  initialUrls?: InitialUrl[];\n\n  /**\n   * Callback when a pre-loaded URL is removed\n   */\n  onRemoveUrl?: (id: string) => void;\n\n  /**\n   * Layout mode for displaying images\n   * @default \"grid\"\n   */\n  layout?: \"grid\" | \"carousel\";\n}\n\n// Format bytes to human readable\nfunction formatBytes(bytes: number): string {\n  if (bytes === 0) {\n    return \"0 B\";\n  }\n  const k = 1024;\n  const sizes = [\"B\", \"KB\", \"MB\", \"GB\"];\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n  return `${Number.parseFloat((bytes / k ** i).toFixed(1))} ${sizes[i]}`;\n}\n\nexport interface ImageUploaderRef {\n  addFiles: (files: File[]) => void;\n  clearFiles: () => void;\n}\n\ninterface CompressionOptionsPanelProps {\n  isOpen: boolean;\n  onOpenChange: (open: boolean) => void;\n  enableCropping: boolean;\n  onEnableCroppingChange: (enabled: boolean) => void;\n  options: CompressionOptions;\n  onOptionsChange: (options: CompressionOptions) => void;\n}\n\nfunction CompressionOptionsPanel({\n  isOpen,\n  onOpenChange,\n  enableCropping,\n  onEnableCroppingChange,\n  options,\n  onOptionsChange,\n}: CompressionOptionsPanelProps) {\n  return (\n    <div className=\"rounded-lg border bg-muted/30 p-4\">\n      <button\n        className=\"flex w-full items-center justify-between font-medium text-sm\"\n        onClick={() => onOpenChange(!isOpen)}\n        type=\"button\"\n      >\n        <span>Compression Options</span>\n        {isOpen ? (\n          <ChevronDown className=\"h-4 w-4\" />\n        ) : (\n          <ChevronRight className=\"h-4 w-4\" />\n        )}\n      </button>\n\n      {isOpen && (\n        <div className=\"mt-4 space-y-4\">\n          {/* Enable cropping toggle */}\n          <div className=\"flex items-center gap-3 rounded-lg border border-primary/20 bg-primary/5 p-3\">\n            <Sparkles className=\"h-5 w-5 text-primary\" />\n            <div className=\"flex flex-1 flex-col gap-1\">\n              <Label className=\"cursor-pointer\" htmlFor=\"enable-cropping\">\n                Enable image cropping\n              </Label>\n              <p className=\"text-muted-foreground text-xs\">\n                Crop, rotate, and flip images before compression\n              </p>\n            </div>\n            <Checkbox\n              checked={enableCropping}\n              id=\"enable-cropping\"\n              onCheckedChange={(checked: boolean) =>\n                onEnableCroppingChange(checked)\n              }\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center justify-between\">\n              <Label htmlFor=\"maxSizeMB\">Max file size (MB)</Label>\n              <span className=\"text-muted-foreground text-sm\">\n                {options.maxSizeMB} MB\n              </span>\n            </div>\n            <Slider\n              id=\"maxSizeMB\"\n              max={10}\n              min={0.1}\n              onValueChange={([value]: number[]) => {\n                if (value !== undefined) {\n                  onOptionsChange({\n                    ...options,\n                    maxSizeMB: value,\n                  });\n                }\n              }}\n              step={0.1}\n              value={[options.maxSizeMB]}\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center justify-between\">\n              <Label htmlFor=\"maxDimension\">Max width/height (px)</Label>\n              <span className=\"text-muted-foreground text-sm\">\n                {options.maxWidthOrHeight} px\n              </span>\n            </div>\n            <Slider\n              id=\"maxDimension\"\n              max={4096}\n              min={480}\n              onValueChange={([value]: number[]) => {\n                if (value !== undefined) {\n                  onOptionsChange({\n                    ...options,\n                    maxWidthOrHeight: value,\n                  });\n                }\n              }}\n              step={32}\n              value={[options.maxWidthOrHeight]}\n            />\n          </div>\n\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center gap-3\">\n              <Checkbox\n                checked={options.useWebWorker}\n                onCheckedChange={(checked: boolean) =>\n                  onOptionsChange({\n                    ...options,\n                    useWebWorker: checked,\n                  })\n                }\n              />\n              <Label className=\"cursor-pointer\">Use Web Worker</Label>\n            </div>\n\n            <div className=\"flex items-center gap-3\">\n              <Checkbox\n                checked={options.alwaysKeepResolution}\n                onCheckedChange={(checked: boolean) =>\n                  onOptionsChange({\n                    ...options,\n                    alwaysKeepResolution: checked,\n                  })\n                }\n              />\n              <Label className=\"cursor-pointer\">Keep resolution</Label>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\ninterface ImageGridListProps {\n  items: CombinedItem[];\n  layout: \"grid\" | \"carousel\";\n  onRemove: (item: CombinedItem) => void;\n  onDownload: (file: CompressedFileWithPreview) => void;\n  onView: (url: string, name: string, type: string) => void;\n  showCompressionDetails: boolean;\n}\n\nfunction ImageGridList({\n  items,\n  layout,\n  onRemove,\n  onDownload,\n  onView,\n  showCompressionDetails,\n}: ImageGridListProps) {\n  const renderItem = (item: CombinedItem) => (\n    <ImageUploaderItem\n      item={item}\n      key={item.id}\n      layout={layout}\n      onDownload={onDownload}\n      onRemove={() => onRemove(item)}\n      onView={onView}\n      showCompressionDetails={showCompressionDetails}\n    />\n  );\n\n  if (layout === \"grid\") {\n    return (\n      <div className=\"grid grid-cols-3 gap-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6\">\n        {items.map((item) => renderItem(item))}\n      </div>\n    );\n  }\n\n  return (\n    <Carousel\n      className=\"mx-auto min-h-[120px] w-full\"\n      opts={{ align: \"start\" }}\n    >\n      <CarouselContent className=\"-ml-2 md:-ml-4\">\n        {items.map((item) => (\n          <CarouselItem className=\"basis-full pl-2 md:pl-4\" key={item.id}>\n            {renderItem(item)}\n          </CarouselItem>\n        ))}\n      </CarouselContent>\n      <CarouselPrevious className=\"left-2 bg-background/80 hover:bg-background\" />\n      <CarouselNext className=\"right-2 bg-background/80 hover:bg-background\" />\n    </Carousel>\n  );\n}\n\nfunction useDragDrop(\n  onFilesSelected: (files: FileList | File[] | null) => void\n) {\n  const [isDragging, setIsDragging] = React.useState(false);\n\n  const handleDragOver = React.useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(true);\n  }, []);\n\n  const handleDragLeave = React.useCallback(() => {\n    setIsDragging(false);\n  }, []);\n\n  const handleDrop = React.useCallback(\n    (e: React.DragEvent) => {\n      e.preventDefault();\n      setIsDragging(false);\n      onFilesSelected(e.dataTransfer.files);\n    },\n    [onFilesSelected]\n  );\n\n  return { isDragging, handleDragOver, handleDragLeave, handleDrop };\n}\n\n// biome-ignore lint/complexity/noExcessiveCognitiveComplexity: Controller manages complex file upload state and workflows\nfunction useImageUploaderController(\n  props: ImageUploaderProps,\n  ref: React.ForwardedRef<ImageUploaderRef>\n) {\n  const {\n    onCompressed,\n    onConfirm,\n    defaultOptions,\n    enableCropping: defaultEnableCropping = false,\n    autoUpload = true,\n    initialUrls,\n  } = props;\n\n  const fileInputRef = React.useRef<HTMLInputElement>(null);\n  const [deleteTarget, setDeleteTarget] = React.useState<{\n    type: \"file\" | \"url\";\n    id: string | number;\n  } | null>(null);\n  const [_sourceFiles, setSourceFiles] = React.useState<File[]>([]);\n  const [compressedFiles, setCompressedFiles] = React.useState<\n    CompressedFileWithPreview[]\n  >([]);\n  const [isCompressing, setIsCompressing] = React.useState(false);\n\n  const [isCompressionOptionsOpen, setIsCompressionOptionsOpen] =\n    React.useState(false);\n  const [compressionOptions, setCompressionOptions] =\n    React.useState<CompressionOptions>({\n      maxSizeMB: defaultOptions?.maxSizeMB ?? 1,\n      maxWidthOrHeight: defaultOptions?.maxWidthOrHeight ?? 1920,\n      useWebWorker: defaultOptions?.useWebWorker ?? true,\n      alwaysKeepResolution: defaultOptions?.alwaysKeepResolution ?? false,\n    });\n\n  // Cropping state\n  const [enableCropping, setEnableCropping] = React.useState(\n    defaultEnableCropping\n  );\n  const [cropDialogOpen, setCropDialogOpen] = React.useState(false);\n  const [fileToCrop, setFileToCrop] = React.useState<File | null>(null);\n  const [cropQueue, setCropQueue] = React.useState<File[]>([]);\n  const [processedCrops, setProcessedCrops] = React.useState<CropResult[]>([]);\n\n  // Preview state\n  const [previewOpen, setPreviewOpen] = React.useState(false);\n  const [previewUrl, setPreviewUrl] = React.useState(\"\");\n  const [previewName, setPreviewName] = React.useState(\"\");\n  const [previewType, setPreviewType] = React.useState(\"\");\n\n  // Dynamically import browser-image-compression to avoid SSR issues\n  const [browserImageCompression, setBrowserImageCompression] = React.useState<\n    typeof import(\"browser-image-compression\").default | null\n  >(null);\n\n  React.useEffect(() => {\n    setEnableCropping(defaultEnableCropping);\n  }, [defaultEnableCropping]);\n\n  React.useEffect(() => {\n    import(\"browser-image-compression\").then((module) => {\n      setBrowserImageCompression(() => module.default);\n    });\n  }, []);\n\n  // Compress a single file\n  const compressSingleFile = React.useCallback(\n    (file: File) => {\n      return compressImageHelper(\n        file,\n        compressionOptions,\n        browserImageCompression\n      );\n    },\n    [browserImageCompression, compressionOptions]\n  );\n\n  // Handle file selection\n  const handleFileSelect = React.useCallback(\n    // biome-ignore lint/complexity/noExcessiveCognitiveComplexity: File selection validation logic is inherently complex\n    (files: FileList | File[] | null, skipCrop = false) => {\n      if (!files) {\n        return;\n      }\n\n      const newFiles = Array.from(files).filter((f) =>\n        f.type.startsWith(\"image/\")\n      );\n\n      if (newFiles.length === 0) {\n        toast.error(\"Please select image files only\");\n        return;\n      }\n\n      if (enableCropping && !skipCrop) {\n        // Add to queue for cropping\n        setCropQueue((prev) => {\n          const existing = prev.map((f) => f.name);\n          const filtered = newFiles.filter((f) => !existing.includes(f.name));\n          return [...prev, ...filtered];\n        });\n\n        // Start cropping if dialog is closed\n        if (!cropDialogOpen && newFiles.length > 0) {\n          setFileToCrop(newFiles[0] ?? null);\n          setCropDialogOpen(true);\n        }\n      } else {\n        // Auto-compress immediately\n        setSourceFiles((prev) => {\n          const existing = prev.map((f) => f.name);\n          const filtered = newFiles.filter((f) => !existing.includes(f.name));\n          return [...prev, ...filtered];\n        });\n\n        if (newFiles.length > 0) {\n          setIsCompressing(true);\n          Promise.all(newFiles.map((file) => compressSingleFile(file)))\n            .then((compressed) => {\n              setCompressedFiles((prev) => {\n                const existingNames = prev.map((f) => f.name);\n                const newCompressed = compressed.filter(\n                  (f) => !existingNames.includes(f.name)\n                );\n\n                const nextFiles = [...prev, ...newCompressed];\n                return nextFiles;\n              });\n\n              if (autoUpload && (!enableCropping || skipCrop)) {\n                setTimeout(() => {\n                  setCompressedFiles((current) => {\n                    onConfirm?.(current);\n                    return current;\n                  });\n                }, 0);\n              }\n\n              const totalOriginal = compressed.reduce(\n                (acc, f) => acc + f.originalSize,\n                0\n              );\n              const totalCompressed = compressed.reduce(\n                (acc, f) => acc + f.compressedSize,\n                0\n              );\n              const saving =\n                ((totalOriginal - totalCompressed) / totalOriginal) * 100;\n\n              toast.success(\n                `Compressed ${compressed.length} image${compressed.length > 1 ? \"s\" : \"\"} - Saved ${saving.toFixed(1)}%`\n              );\n\n              onCompressed?.(compressed);\n            })\n            .catch(() => {\n              toast.error(\"Compression failed\");\n            })\n            .finally(() => {\n              setIsCompressing(false);\n            });\n        }\n      }\n    },\n    [\n      compressSingleFile,\n      cropDialogOpen,\n      enableCropping,\n      onCompressed,\n      autoUpload,\n      onConfirm,\n    ]\n  );\n\n  // biome-ignore lint/complexity/noExcessiveCognitiveComplexity: Complex logic\n  const compressAndUploadCrops = React.useCallback(\n    (allCrops: CropResult[]) => {\n      setIsCompressing(true);\n\n      Promise.all(\n        allCrops.map((cropResult) => {\n          const cropFile = new File([cropResult.blob], cropResult.file.name, {\n            type: cropResult.file.type,\n          });\n          return compressSingleFile(cropFile);\n        })\n      )\n        .then((compressed) => {\n          setCompressedFiles((prev) => {\n            const existingNames = prev.map((f) => f.name);\n            const newCompressed = compressed.filter(\n              (f) => !existingNames.includes(f.name)\n            );\n            return [...prev, ...newCompressed];\n          });\n\n          if (autoUpload) {\n            setTimeout(() => {\n              setCompressedFiles((current) => {\n                onConfirm?.(current);\n                return current;\n              });\n            }, 0);\n          }\n\n          setProcessedCrops([]);\n\n          const totalOriginal = compressed.reduce(\n            (acc, f) => acc + f.originalSize,\n            0\n          );\n          const totalCompressed = compressed.reduce(\n            (acc, f) => acc + f.compressedSize,\n            0\n          );\n          const saving =\n            ((totalOriginal - totalCompressed) / totalOriginal) * 100;\n\n          toast.success(\n            `Processed ${compressed.length} image${compressed.length > 1 ? \"s\" : \"\"} - Saved ${saving.toFixed(1)}%`\n          );\n\n          onCompressed?.(compressed);\n        })\n        .catch(() => {\n          toast.error(\"Compression failed\");\n        })\n        .finally(() => {\n          setIsCompressing(false);\n        });\n    },\n    [compressSingleFile, autoUpload, onConfirm, onCompressed]\n  );\n\n  // Handle crop complete\n  // biome-ignore lint/complexity/noExcessiveCognitiveComplexity: Complex logic\n  const handleCropComplete = React.useCallback(\n\n    (result: CropResult) => {\n      setProcessedCrops((prev) => [...prev, result]);\n      setCropQueue((prev) => prev.filter((f) => f.name !== result.file.name));\n\n      // Process next in queue\n      const remaining = cropQueue.filter((f) => f.name !== result.file.name);\n      if (remaining.length > 0) {\n        setFileToCrop(remaining[0] ?? null);\n        return;\n      }\n\n      setFileToCrop(null);\n      setCropDialogOpen(false);\n\n      // All images cropped, now compress\n      const allCrops = [...processedCrops, result];\n      compressAndUploadCrops(allCrops);\n    },\n    [cropQueue, processedCrops, compressAndUploadCrops]\n  );\n\n  // Handle skip crop\n  const handleSkipCrop = React.useCallback(() => {\n    if (!fileToCrop) {\n      return;\n    }\n\n    // Skip this file and move to next\n    setCropQueue((prev) => prev.filter((f) => f.name !== fileToCrop.name));\n\n    const remaining = cropQueue.filter((f) => f.name !== fileToCrop.name);\n    if (remaining.length > 0) {\n      setFileToCrop(remaining[0] ?? null);\n    } else {\n      setFileToCrop(null);\n      setCropDialogOpen(false);\n    }\n  }, [cropQueue, fileToCrop]);\n\n  // Remove compressed file\n  const removeCompressedFile = React.useCallback((index: number) => {\n    setCompressedFiles((prev) => {\n      const file = prev[index];\n      if (file?.preview) {\n        URL.revokeObjectURL(file.preview);\n      }\n      return prev.filter((_, idx) => idx !== index);\n    });\n  }, []);\n\n  // Download compressed file\n  const downloadFile = React.useCallback((file: CompressedFileWithPreview) => {\n    if (file.preview) {\n      const link = document.createElement(\"a\");\n      link.href = file.preview;\n      link.download = file.name;\n      link.click();\n    }\n  }, []);\n\n  // Clear all\n  const clearAll = React.useCallback(() => {\n    for (const f of compressedFiles) {\n      if (f.preview) {\n        URL.revokeObjectURL(f.preview);\n      }\n    }\n    for (const f of processedCrops) {\n      URL.revokeObjectURL(f.url);\n    }\n    setSourceFiles([]);\n    setCompressedFiles([]);\n    setCropQueue([]);\n    setProcessedCrops([]);\n  }, [compressedFiles, processedCrops]);\n\n  React.useImperativeHandle(ref, () => ({\n    addFiles: (files: File[]) => handleFileSelect(files, true),\n    clearFiles: clearAll,\n  }));\n\n  const { isDragging, handleDragOver, handleDragLeave, handleDrop } =\n    useDragDrop(handleFileSelect);\n\n  // Cleanup previews on unmount\n  React.useEffect(() => {\n    return () => {\n      for (const f of compressedFiles) {\n        if (f.preview) {\n          URL.revokeObjectURL(f.preview);\n        }\n      }\n      for (const f of processedCrops) {\n        URL.revokeObjectURL(f.url);\n      }\n    };\n  }, [compressedFiles, processedCrops]);\n\n  const hasFilesInQueue = cropQueue.length > 0 || processedCrops.length > 0;\n  const totalInQueue = cropQueue.length + processedCrops.length;\n  const hasInitialUrls = initialUrls && initialUrls.length > 0;\n  const hasAnyFiles =\n    compressedFiles.length > 0 || hasFilesInQueue || hasInitialUrls;\n\n  const combinedItems = React.useMemo<CombinedItem[]>(\n    () => [\n      ...(initialUrls || []).map((url) => ({\n        type: \"url\" as const,\n        id: url.id,\n        data: url,\n      })),\n      ...compressedFiles.map((file, index) => ({\n        type: \"file\" as const,\n        id: file.name || index,\n        data: file,\n      })),\n    ],\n    [initialUrls, compressedFiles]\n  );\n\n  return {\n    fileInputRef,\n    deleteTarget,\n    setDeleteTarget,\n    compressedFiles,\n    isCompressing,\n    isDragging,\n    isCompressionOptionsOpen,\n    setIsCompressionOptionsOpen,\n    compressionOptions,\n    setCompressionOptions,\n    enableCropping,\n    setEnableCropping,\n    cropDialogOpen,\n    setCropDialogOpen,\n    fileToCrop,\n    setFileToCrop,\n    cropQueue,\n    processedCrops,\n    previewOpen,\n    setPreviewOpen,\n    previewUrl,\n    setPreviewUrl,\n    previewName,\n    setPreviewName,\n    previewType,\n    setPreviewType,\n    handleFileSelect,\n    handleCropComplete,\n    handleSkipCrop,\n    removeCompressedFile,\n    downloadFile,\n    clearAll,\n    handleDragOver,\n    handleDragLeave,\n    handleDrop,\n    hasFilesInQueue,\n    totalInQueue,\n    hasInitialUrls,\n    hasAnyFiles,\n    combinedItems,\n  };\n}\n\nexport const ImageUploader = React.forwardRef<\n  ImageUploaderRef,\n  ImageUploaderProps\n>((props, ref) => {\n  const {\n    className,\n    showCompressionOptions = false,\n    showCompressionDetails = false,\n    showConfirmButton = true,\n    onConfirm,\n    isUploading = false,\n    initialUrls,\n    onRemoveUrl,\n    layout = \"grid\",\n  } = props;\n\n  const controller = useImageUploaderController(props, ref);\n\n  return (\n    <div className={cn(\"space-y-4\", className)}>\n      {/* Options */}\n      {showCompressionOptions && (\n        <CompressionOptionsPanel\n          enableCropping={controller.enableCropping}\n          isOpen={controller.isCompressionOptionsOpen}\n          onEnableCroppingChange={controller.setEnableCropping}\n          onOpenChange={controller.setIsCompressionOptionsOpen}\n          onOptionsChange={controller.setCompressionOptions}\n          options={controller.compressionOptions}\n        />\n      )}\n\n      {/* File Preview Dialog */}\n      <FilePreviewDialog\n        fileName={controller.previewName}\n        fileType={controller.previewType}\n        fileUrl={controller.previewUrl}\n        onOpenChange={controller.setPreviewOpen}\n        open={controller.previewOpen}\n      />\n\n      {/* Upload Area */}\n      {controller.hasAnyFiles ? (\n        <div className=\"space-y-3\">\n          {/* Crop queue indicator */}\n          {controller.hasFilesInQueue && (\n            <div className=\"flex items-center gap-3 rounded-lg border border-primary/20 bg-primary/5 p-3\">\n              <Crop className=\"h-5 w-5 animate-pulse text-primary\" />\n              <div className=\"flex flex-1 flex-col\">\n                <p className=\"font-medium text-sm\">\n                  Processing {controller.totalInQueue} image\n                  {controller.totalInQueue > 1 ? \"s\" : \"\"}\n                </p>\n                <p className=\"text-muted-foreground text-xs\">\n                  {controller.processedCrops.length} of{\" \"}\n                  {controller.totalInQueue} cropped\n                </p>\n              </div>\n              <Loader2 className=\"h-5 w-5 animate-spin text-primary\" />\n            </div>\n          )}\n\n          {/* Add more files button */}\n          <DropzonePrimitive\n            className=\"py-2\"\n            compact={true}\n            onClick={() => {\n              controller.fileInputRef.current?.click();\n            }}\n            onDragLeave={controller.handleDragLeave}\n            onDragOver={controller.handleDragOver}\n            onDrop={controller.handleDrop}\n            onKeyDown={(e) => {\n              if (e.key === \"Enter\" || e.key === \" \") {\n                e.preventDefault();\n                controller.fileInputRef.current?.click();\n              }\n            }}\n          >\n            <Plus className=\"mr-2 h-4 w-4\" />\n            Add more images\n            <input\n              accept=\"image/*\"\n              className=\"hidden\"\n              multiple\n              onChange={(e) => controller.handleFileSelect(e.target.files)}\n              ref={controller.fileInputRef}\n              type=\"file\"\n            />\n          </DropzonePrimitive>\n\n          {/* Images list (Unified) */}\n          {controller.hasAnyFiles &&\n            (controller.compressedFiles.length > 0 ||\n              controller.hasInitialUrls) && (\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between\">\n                  <h3 className=\"font-medium text-sm\">\n                    Images (\n                    {(initialUrls?.length || 0) +\n                      controller.compressedFiles.length}\n                    )\n                  </h3>\n                  {controller.compressedFiles.length > 0 && (\n                    <Button\n                      className=\"text-muted-foreground text-xs\"\n                      disabled={controller.isCompressing}\n                      onClick={controller.clearAll}\n                      size=\"sm\"\n                      variant=\"ghost\"\n                    >\n                      Clear new\n                    </Button>\n                  )}\n                </div>\n                <ImageGridList\n                  items={controller.combinedItems}\n                  layout={layout}\n                  onDownload={controller.downloadFile}\n                  onRemove={(item) => {\n                    if (item.type === \"url\") {\n                      controller.setDeleteTarget({\n                        type: \"url\",\n                        id: item.id,\n                      });\n                    } else {\n                      // Find index in compressedFiles\n                      const index = controller.compressedFiles.indexOf(\n                        item.data as CompressedFileWithPreview\n                      );\n                      controller.setDeleteTarget({\n                        type: \"file\",\n                        id: index,\n                      });\n                    }\n                  }}\n                  onView={(url, name, type) => {\n                    controller.setPreviewUrl(url);\n                    controller.setPreviewName(name);\n                    controller.setPreviewType(type);\n                    controller.setPreviewOpen(true);\n                  }}\n                  showCompressionDetails={showCompressionDetails}\n                />\n              </div>\n            )}\n\n          {/* Loading state */}\n          {controller.isCompressing && (\n            <div className=\"flex items-center justify-center gap-2 rounded-lg border bg-muted/30 py-4 text-muted-foreground text-sm\">\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\n              Processing images...\n            </div>\n          )}\n\n          {/* Confirm Button */}\n          {showConfirmButton &&\n            onConfirm &&\n            controller.compressedFiles.length > 0 && (\n              <Button\n                className=\"w-full\"\n                disabled={isUploading || controller.isCompressing}\n                onClick={() => onConfirm(controller.compressedFiles)}\n              >\n                {isUploading ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Uploading...\n                  </>\n                ) : (\n                  <>\n                    <Upload className=\"mr-2 h-4 w-4\" />\n                    Confirm Upload ({controller.compressedFiles.length})\n                  </>\n                )}\n              </Button>\n            )}\n        </div>\n      ) : (\n        <DropzonePrimitive\n          className={cn(\n            \"gap-4\",\n            controller.isDragging\n              ? \"border-primary bg-primary/5\"\n              : \"border-muted-foreground/25 hover:border-primary/50 hover:bg-muted/50\"\n          )}\n          compact={false}\n          onClick={() => {\n            controller.fileInputRef.current?.click();\n          }}\n          onDragLeave={controller.handleDragLeave}\n          onDragOver={controller.handleDragOver}\n          onDrop={controller.handleDrop}\n          onKeyDown={(e) => {\n            if (e.key === \"Enter\" || e.key === \" \") {\n              e.preventDefault();\n              controller.fileInputRef.current?.click();\n            }\n          }}\n        >\n          <FileImage className=\"h-10 w-10 text-muted-foreground\" />\n          <div className=\"space-y-1 text-center sm:text-left\">\n            <p className=\"font-medium text-lg\">Drop images here</p>\n            <p className=\"text-muted-foreground text-sm\">or click to browse</p>\n          </div>\n          <input\n            accept=\"image/*\"\n            className=\"hidden\"\n            multiple\n            onChange={(e) => controller.handleFileSelect(e.target.files)}\n            ref={controller.fileInputRef}\n            type=\"file\"\n          />\n        </DropzonePrimitive>\n      )}\n\n      {/* Crop Dialog */}\n      <ImageCropDialog\n        imageFile={controller.fileToCrop}\n        onCropComplete={controller.handleCropComplete}\n        onOpenChange={(open: boolean) => {\n          if (open) {\n            controller.setCropDialogOpen(open);\n          } else {\n            controller.handleSkipCrop();\n          }\n        }}\n        onSelectFile={controller.setFileToCrop}\n        open={controller.cropDialogOpen}\n        queue={controller.cropQueue}\n      />\n\n      <ConfirmDialog\n        description=\"This action cannot be undone.\"\n        onCancel={() => controller.setDeleteTarget(null)}\n        onConfirm={() => {\n          if (controller.deleteTarget?.type === \"file\") {\n            controller.removeCompressedFile(\n              controller.deleteTarget.id as number\n            );\n          } else if (controller.deleteTarget?.type === \"url\") {\n            onRemoveUrl?.(controller.deleteTarget.id as string);\n          }\n          controller.setDeleteTarget(null);\n        }}\n        onOpenChange={(open) => !open && controller.setDeleteTarget(null)}\n        open={!!controller.deleteTarget}\n        title=\"Are you sure?\"\n        variant=\"destructive\"\n      />\n    </div>\n  );\n});\ninterface ImagePreviewCardProps {\n  src: string;\n  alt: string;\n  onView?: () => void;\n  onDownload?: () => void;\n  onRemove?: () => void;\n  children?: React.ReactNode;\n  className?: string;\n}\n\nfunction ImagePreviewCard({\n  src,\n  alt,\n  onView,\n  onDownload,\n  onRemove,\n  children,\n  className,\n}: ImagePreviewCardProps) {\n  const containerRef = React.useRef<HTMLDivElement>(null);\n  const [width, setWidth] = React.useState(0);\n\n  React.useEffect(() => {\n    if (!containerRef.current) {\n      return;\n    }\n    const observer = new ResizeObserver((entries) => {\n      for (const entry of entries) {\n        setWidth(entry.contentRect.width);\n      }\n    });\n    observer.observe(containerRef.current);\n    return () => observer.disconnect();\n  }, []);\n\n  const isSmall = width < 100;\n\n  return (\n    <div\n      className={cn(\n        \"group relative aspect-square overflow-hidden rounded-lg border bg-card\",\n        className\n      )}\n      ref={containerRef}\n    >\n      {/* Thumbnail */}\n      {src ? (\n        // biome-ignore lint/correctness/useImageSize: Dynamic content\n        // biome-ignore lint/performance/noImgElement: Framework-agnostic\n        <img alt={alt} className=\"size-full object-cover\" src={src} />\n      ) : (\n        <div className=\"flex size-full items-center justify-center bg-muted\">\n          <FileImage className=\"h-8 w-8 text-muted-foreground\" />\n        </div>\n      )}\n\n      {/* Overlay on hover */}\n      <div className=\"absolute inset-0 flex flex-col justify-between bg-black/60 p-2 opacity-0 transition-opacity group-hover:opacity-100 data-[state=open]:opacity-100\">\n        {/* Actions at top */}\n        <div className=\"flex justify-end\">\n          {isSmall ? (\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button\n                  className=\"size-6 p-0 text-white hover:bg-white/20 hover:text-white\"\n                  size=\"icon\"\n                  variant=\"ghost\"\n                >\n                  <MoreVertical className=\"size-4\" />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                {onView && (\n                  <DropdownMenuItem onClick={onView}>\n                    <Eye className=\"mr-2 size-4\" /> View\n                  </DropdownMenuItem>\n                )}\n                {onDownload && (\n                  <DropdownMenuItem onClick={onDownload}>\n                    <Download className=\"mr-2 size-4\" /> Download\n                  </DropdownMenuItem>\n                )}\n                {onRemove && (\n                  <DropdownMenuItem\n                    className=\"text-destructive focus:text-destructive\"\n                    onClick={onRemove}\n                  >\n                    <X className=\"mr-2 size-4\" /> Remove\n                  </DropdownMenuItem>\n                )}\n              </DropdownMenuContent>\n            </DropdownMenu>\n          ) : (\n            <div className=\"flex justify-end gap-0.5\">\n              {onView && (\n                <Button\n                  className=\"size-6.5 p-0\"\n                  onClick={onView}\n                  size=\"icon\"\n                  title=\"View\"\n                  variant=\"secondary\"\n                >\n                  <Eye className=\"size-3.5\" />\n                </Button>\n              )}\n              {onDownload && (\n                <Button\n                  className=\"size-6.5 p-0\"\n                  onClick={onDownload}\n                  size=\"icon\"\n                  title=\"Download\"\n                  variant=\"secondary\"\n                >\n                  <Download className=\"size-3.5\" />\n                </Button>\n              )}\n              {onRemove && (\n                <Button\n                  className=\"size-6.5 p-0\"\n                  onClick={onRemove}\n                  size=\"icon\"\n                  title=\"Remove\"\n                  variant=\"destructive\"\n                >\n                  <X className=\"size-3.5\" />\n                </Button>\n              )}\n            </div>\n          )}\n        </div>\n\n        {/* File info at bottom */}\n        {children}\n      </div>\n\n      {/* Filename visible at bottom when not hovering/open */}\n      <div className=\"absolute right-0 bottom-0 left-0 rounded-b-lg bg-gradient-to-t from-black/70 to-transparent p-2 opacity-100 transition-opacity group-hover:opacity-0\">\n        <p className=\"truncate font-medium text-white text-xs\" title={alt}>\n          {alt}\n        </p>\n      </div>\n    </div>\n  );\n}\n\nfunction ImageUploaderItem({\n  item,\n  layout,\n  onDownload,\n  onRemove,\n  onView,\n  showCompressionDetails,\n}: {\n  item: CombinedItem;\n  layout: \"grid\" | \"carousel\";\n  onDownload: (file: CompressedFileWithPreview) => void;\n  onRemove: () => void;\n  onView: (url: string, name: string, type: string) => void;\n  showCompressionDetails: boolean;\n}) {\n  if (item.type === \"url\") {\n    const urlData = item.data as InitialUrl;\n    return (\n      <ImagePreviewCard\n        alt={urlData.name || \"\"}\n        className={layout === \"carousel\" ? \"aspect-video w-full\" : undefined}\n        onDownload={() => window.open(urlData.url, \"_blank\")}\n        onRemove={onRemove}\n        onView={() => onView(urlData.url, urlData.name || \"Preview\", \"image/*\")}\n        src={urlData.url}\n      />\n    );\n  }\n\n  const fileData = item.data as CompressedFileWithPreview;\n  const savings = (\n    ((fileData.originalSize - fileData.compressedSize) /\n      fileData.originalSize) *\n    100\n  ).toFixed(1);\n\n  return (\n    <ImagePreviewCard\n      alt={fileData.name}\n      className={layout === \"carousel\" ? \"aspect-video w-full\" : undefined}\n      onDownload={() => onDownload(fileData)}\n      onRemove={onRemove}\n      onView={\n        fileData.preview\n          ? () => onView(fileData.preview ?? \"\", fileData.name, fileData.type)\n          : undefined\n      }\n      src={fileData.preview || \"\"}\n    >\n      <div className=\"space-y-0.5\">\n        <p className=\"truncate font-medium text-[10px] text-white\">\n          {fileData.name}\n        </p>\n        <div className=\"flex justify-between text-[10px] text-white/80\">\n          <span>{formatBytes(fileData.compressedSize)}</span>\n          {showCompressionDetails && (\n            <Badge\n              className=\"text-xs\"\n              variant={Number.parseFloat(savings) > 0 ? \"default\" : \"secondary\"}\n            >\n              {Number.parseFloat(savings) > 0 ? `-${savings}%` : \"0%\"}\n            </Badge>\n          )}\n        </div>\n      </div>\n    </ImagePreviewCard>\n  );\n}\n\nasync function compressImageHelper(\n  file: File,\n  options: CompressionOptions,\n  // biome-ignore lint/suspicious/noExplicitAny: Dynamic import type is complex\n  browserImageCompression: any\n): Promise<CompressedFileWithPreview> {\n  if (!browserImageCompression) {\n    return Object.assign(file, {\n      originalSize: file.size,\n      compressedSize: file.size,\n      preview: URL.createObjectURL(file),\n    }) as CompressedFileWithPreview;\n  }\n\n  if (!file.type.startsWith(\"image/\")) {\n    return Object.assign(file, {\n      originalSize: file.size,\n      compressedSize: file.size,\n      preview: URL.createObjectURL(file),\n    }) as CompressedFileWithPreview;\n  }\n\n  try {\n    const opts = {\n      maxSizeMB: options.maxSizeMB,\n      maxWidthOrHeight: options.maxWidthOrHeight,\n      useWebWorker: options.useWebWorker,\n      alwaysKeepResolution: options.alwaysKeepResolution,\n    };\n    const blob = await browserImageCompression(file, opts);\n    const preview = URL.createObjectURL(blob);\n    const compressedFile = new window.File([blob], file.name, {\n      type: file.type,\n    }) as CompressedFileWithPreview;\n    compressedFile.originalSize = file.size;\n    compressedFile.compressedSize = compressedFile.size;\n    compressedFile.preview = preview;\n    return compressedFile;\n  } catch (e) {\n    console.error(\"Compression failed for\", file.name, e);\n    return Object.assign(file, {\n      originalSize: file.size,\n      compressedSize: file.size,\n      preview: URL.createObjectURL(file), // Fallback preview\n    }) as CompressedFileWithPreview;\n  }\n}\n"
      },
      "tags": [],
      "source": null
    },
    {
      "category": "suppressions/unused",
      "severity": "warning",
      "description": "Suppression comment has no effect. Remove the suppression or make sure you are suppressing the correct rule.",
      "message": [
        {
          "elements": [],
          "content": "Suppression comment has no effect. Remove the suppression or make sure you are suppressing the correct rule."
        }
      ],
      "advices": { "advices": [] },
      "verboseAdvices": { "advices": [] },
      "location": {
        "path": {
          "file": "packages\\ui\\src\\composed\\file-upload\\image-uploader.tsx"
        },
        "span": [17308, 17385],
        "sourceCode": "\"use client\";\n\n\nimport {\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselNext,\n  CarouselPrevious,\n} from \"@workspace/ui/components/carousel\";\nimport { cn } from \"@workspace/ui/lib/utils\";\n\nimport {\n  ChevronDown,\n  ChevronRight,\n  Crop,\n  Download,\n  Eye,\n  FileImage,\n  Loader2,\n  MoreVertical,\n  Plus,\n  Sparkles,\n  Upload,\n  X,\n} from \"lucide-react\";\nimport * as React from \"react\";\nimport { toast } from \"sonner\";\nimport { Badge } from \"../../components/badge\";\nimport { Button } from \"../../components/button\";\nimport { Checkbox } from \"../../components/checkbox\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"../../components/dropdown-menu\";\nimport { Label } from \"../../components/label\";\nimport { Slider } from \"../../components/slider\";\nimport { ConfirmDialog } from \"../confirm-dialog\"; // Import ConfirmDialog\nimport { FilePreviewDialog } from \"../file-preview/file-preview-dialog\";\nimport { DropzonePrimitive } from \"./dropzone-primitive\";\nimport { type CropResult, ImageCropDialog } from \"./image-crop-dialog\";\n\nexport interface CompressionOptions {\n  maxSizeMB: number;\n  maxWidthOrHeight: number;\n  useWebWorker: boolean;\n  alwaysKeepResolution: boolean;\n}\n\nexport interface CompressedFileWithPreview extends File {\n  originalSize: number;\n  compressedSize: number;\n  preview?: string;\n}\n\n/**\n * Pre-loaded image URL for edit mode display\n */\nexport interface InitialUrl {\n  id: string;\n  url: string;\n  name?: string;\n}\n\ntype CombinedItem =\n  | { type: \"url\"; id: string | number; data: InitialUrl }\n  | { type: \"file\"; id: string | number; data: CompressedFileWithPreview };\n\nexport interface ImageUploaderProps {\n  /**\n   * Callback when files are compressed\n   */\n  onCompressed?: (files: CompressedFileWithPreview[]) => void;\n\n  /**\n   * Callback when upload is requested/confirmed\n   */\n  onConfirm?: (files: CompressedFileWithPreview[]) => void;\n\n  /**\n   * Default compression options\n   */\n  defaultOptions?: Partial<CompressionOptions>;\n\n  /**\n   * Show upload/confirm button after compression\n   */\n  showConfirmButton?: boolean;\n  /**\n   * Show compression options UI\n   * @default false\n   */\n  showCompressionOptions?: boolean;\n\n  /**\n   * Enable cropping by default\n   * @default false\n   */\n  enableCropping?: boolean;\n\n  /**\n   * Automatically upload after compression (if cropping is disabled)\n   * @default false\n   */\n  autoUpload?: boolean;\n\n  /**\n   * Is currently uploading\n   */\n  isUploading?: boolean;\n\n  className?: string;\n  showCompressionDetails?: boolean;\n  /**\n   * Pre-loaded image URLs for edit mode (display-only with remove)\n   */\n  initialUrls?: InitialUrl[];\n\n  /**\n   * Callback when a pre-loaded URL is removed\n   */\n  onRemoveUrl?: (id: string) => void;\n\n  /**\n   * Layout mode for displaying images\n   * @default \"grid\"\n   */\n  layout?: \"grid\" | \"carousel\";\n}\n\n// Format bytes to human readable\nfunction formatBytes(bytes: number): string {\n  if (bytes === 0) {\n    return \"0 B\";\n  }\n  const k = 1024;\n  const sizes = [\"B\", \"KB\", \"MB\", \"GB\"];\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n  return `${Number.parseFloat((bytes / k ** i).toFixed(1))} ${sizes[i]}`;\n}\n\nexport interface ImageUploaderRef {\n  addFiles: (files: File[]) => void;\n  clearFiles: () => void;\n}\n\ninterface CompressionOptionsPanelProps {\n  isOpen: boolean;\n  onOpenChange: (open: boolean) => void;\n  enableCropping: boolean;\n  onEnableCroppingChange: (enabled: boolean) => void;\n  options: CompressionOptions;\n  onOptionsChange: (options: CompressionOptions) => void;\n}\n\nfunction CompressionOptionsPanel({\n  isOpen,\n  onOpenChange,\n  enableCropping,\n  onEnableCroppingChange,\n  options,\n  onOptionsChange,\n}: CompressionOptionsPanelProps) {\n  return (\n    <div className=\"rounded-lg border bg-muted/30 p-4\">\n      <button\n        className=\"flex w-full items-center justify-between font-medium text-sm\"\n        onClick={() => onOpenChange(!isOpen)}\n        type=\"button\"\n      >\n        <span>Compression Options</span>\n        {isOpen ? (\n          <ChevronDown className=\"h-4 w-4\" />\n        ) : (\n          <ChevronRight className=\"h-4 w-4\" />\n        )}\n      </button>\n\n      {isOpen && (\n        <div className=\"mt-4 space-y-4\">\n          {/* Enable cropping toggle */}\n          <div className=\"flex items-center gap-3 rounded-lg border border-primary/20 bg-primary/5 p-3\">\n            <Sparkles className=\"h-5 w-5 text-primary\" />\n            <div className=\"flex flex-1 flex-col gap-1\">\n              <Label className=\"cursor-pointer\" htmlFor=\"enable-cropping\">\n                Enable image cropping\n              </Label>\n              <p className=\"text-muted-foreground text-xs\">\n                Crop, rotate, and flip images before compression\n              </p>\n            </div>\n            <Checkbox\n              checked={enableCropping}\n              id=\"enable-cropping\"\n              onCheckedChange={(checked: boolean) =>\n                onEnableCroppingChange(checked)\n              }\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center justify-between\">\n              <Label htmlFor=\"maxSizeMB\">Max file size (MB)</Label>\n              <span className=\"text-muted-foreground text-sm\">\n                {options.maxSizeMB} MB\n              </span>\n            </div>\n            <Slider\n              id=\"maxSizeMB\"\n              max={10}\n              min={0.1}\n              onValueChange={([value]: number[]) => {\n                if (value !== undefined) {\n                  onOptionsChange({\n                    ...options,\n                    maxSizeMB: value,\n                  });\n                }\n              }}\n              step={0.1}\n              value={[options.maxSizeMB]}\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center justify-between\">\n              <Label htmlFor=\"maxDimension\">Max width/height (px)</Label>\n              <span className=\"text-muted-foreground text-sm\">\n                {options.maxWidthOrHeight} px\n              </span>\n            </div>\n            <Slider\n              id=\"maxDimension\"\n              max={4096}\n              min={480}\n              onValueChange={([value]: number[]) => {\n                if (value !== undefined) {\n                  onOptionsChange({\n                    ...options,\n                    maxWidthOrHeight: value,\n                  });\n                }\n              }}\n              step={32}\n              value={[options.maxWidthOrHeight]}\n            />\n          </div>\n\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center gap-3\">\n              <Checkbox\n                checked={options.useWebWorker}\n                onCheckedChange={(checked: boolean) =>\n                  onOptionsChange({\n                    ...options,\n                    useWebWorker: checked,\n                  })\n                }\n              />\n              <Label className=\"cursor-pointer\">Use Web Worker</Label>\n            </div>\n\n            <div className=\"flex items-center gap-3\">\n              <Checkbox\n                checked={options.alwaysKeepResolution}\n                onCheckedChange={(checked: boolean) =>\n                  onOptionsChange({\n                    ...options,\n                    alwaysKeepResolution: checked,\n                  })\n                }\n              />\n              <Label className=\"cursor-pointer\">Keep resolution</Label>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\ninterface ImageGridListProps {\n  items: CombinedItem[];\n  layout: \"grid\" | \"carousel\";\n  onRemove: (item: CombinedItem) => void;\n  onDownload: (file: CompressedFileWithPreview) => void;\n  onView: (url: string, name: string, type: string) => void;\n  showCompressionDetails: boolean;\n}\n\nfunction ImageGridList({\n  items,\n  layout,\n  onRemove,\n  onDownload,\n  onView,\n  showCompressionDetails,\n}: ImageGridListProps) {\n  const renderItem = (item: CombinedItem) => (\n    <ImageUploaderItem\n      item={item}\n      key={item.id}\n      layout={layout}\n      onDownload={onDownload}\n      onRemove={() => onRemove(item)}\n      onView={onView}\n      showCompressionDetails={showCompressionDetails}\n    />\n  );\n\n  if (layout === \"grid\") {\n    return (\n      <div className=\"grid grid-cols-3 gap-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6\">\n        {items.map((item) => renderItem(item))}\n      </div>\n    );\n  }\n\n  return (\n    <Carousel\n      className=\"mx-auto min-h-[120px] w-full\"\n      opts={{ align: \"start\" }}\n    >\n      <CarouselContent className=\"-ml-2 md:-ml-4\">\n        {items.map((item) => (\n          <CarouselItem className=\"basis-full pl-2 md:pl-4\" key={item.id}>\n            {renderItem(item)}\n          </CarouselItem>\n        ))}\n      </CarouselContent>\n      <CarouselPrevious className=\"left-2 bg-background/80 hover:bg-background\" />\n      <CarouselNext className=\"right-2 bg-background/80 hover:bg-background\" />\n    </Carousel>\n  );\n}\n\nfunction useDragDrop(\n  onFilesSelected: (files: FileList | File[] | null) => void\n) {\n  const [isDragging, setIsDragging] = React.useState(false);\n\n  const handleDragOver = React.useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(true);\n  }, []);\n\n  const handleDragLeave = React.useCallback(() => {\n    setIsDragging(false);\n  }, []);\n\n  const handleDrop = React.useCallback(\n    (e: React.DragEvent) => {\n      e.preventDefault();\n      setIsDragging(false);\n      onFilesSelected(e.dataTransfer.files);\n    },\n    [onFilesSelected]\n  );\n\n  return { isDragging, handleDragOver, handleDragLeave, handleDrop };\n}\n\n// biome-ignore lint/complexity/noExcessiveCognitiveComplexity: Controller manages complex file upload state and workflows\nfunction useImageUploaderController(\n  props: ImageUploaderProps,\n  ref: React.ForwardedRef<ImageUploaderRef>\n) {\n  const {\n    onCompressed,\n    onConfirm,\n    defaultOptions,\n    enableCropping: defaultEnableCropping = false,\n    autoUpload = true,\n    initialUrls,\n  } = props;\n\n  const fileInputRef = React.useRef<HTMLInputElement>(null);\n  const [deleteTarget, setDeleteTarget] = React.useState<{\n    type: \"file\" | \"url\";\n    id: string | number;\n  } | null>(null);\n  const [_sourceFiles, setSourceFiles] = React.useState<File[]>([]);\n  const [compressedFiles, setCompressedFiles] = React.useState<\n    CompressedFileWithPreview[]\n  >([]);\n  const [isCompressing, setIsCompressing] = React.useState(false);\n\n  const [isCompressionOptionsOpen, setIsCompressionOptionsOpen] =\n    React.useState(false);\n  const [compressionOptions, setCompressionOptions] =\n    React.useState<CompressionOptions>({\n      maxSizeMB: defaultOptions?.maxSizeMB ?? 1,\n      maxWidthOrHeight: defaultOptions?.maxWidthOrHeight ?? 1920,\n      useWebWorker: defaultOptions?.useWebWorker ?? true,\n      alwaysKeepResolution: defaultOptions?.alwaysKeepResolution ?? false,\n    });\n\n  // Cropping state\n  const [enableCropping, setEnableCropping] = React.useState(\n    defaultEnableCropping\n  );\n  const [cropDialogOpen, setCropDialogOpen] = React.useState(false);\n  const [fileToCrop, setFileToCrop] = React.useState<File | null>(null);\n  const [cropQueue, setCropQueue] = React.useState<File[]>([]);\n  const [processedCrops, setProcessedCrops] = React.useState<CropResult[]>([]);\n\n  // Preview state\n  const [previewOpen, setPreviewOpen] = React.useState(false);\n  const [previewUrl, setPreviewUrl] = React.useState(\"\");\n  const [previewName, setPreviewName] = React.useState(\"\");\n  const [previewType, setPreviewType] = React.useState(\"\");\n\n  // Dynamically import browser-image-compression to avoid SSR issues\n  const [browserImageCompression, setBrowserImageCompression] = React.useState<\n    typeof import(\"browser-image-compression\").default | null\n  >(null);\n\n  React.useEffect(() => {\n    setEnableCropping(defaultEnableCropping);\n  }, [defaultEnableCropping]);\n\n  React.useEffect(() => {\n    import(\"browser-image-compression\").then((module) => {\n      setBrowserImageCompression(() => module.default);\n    });\n  }, []);\n\n  // Compress a single file\n  const compressSingleFile = React.useCallback(\n    (file: File) => {\n      return compressImageHelper(\n        file,\n        compressionOptions,\n        browserImageCompression\n      );\n    },\n    [browserImageCompression, compressionOptions]\n  );\n\n  // Handle file selection\n  const handleFileSelect = React.useCallback(\n    // biome-ignore lint/complexity/noExcessiveCognitiveComplexity: File selection validation logic is inherently complex\n    (files: FileList | File[] | null, skipCrop = false) => {\n      if (!files) {\n        return;\n      }\n\n      const newFiles = Array.from(files).filter((f) =>\n        f.type.startsWith(\"image/\")\n      );\n\n      if (newFiles.length === 0) {\n        toast.error(\"Please select image files only\");\n        return;\n      }\n\n      if (enableCropping && !skipCrop) {\n        // Add to queue for cropping\n        setCropQueue((prev) => {\n          const existing = prev.map((f) => f.name);\n          const filtered = newFiles.filter((f) => !existing.includes(f.name));\n          return [...prev, ...filtered];\n        });\n\n        // Start cropping if dialog is closed\n        if (!cropDialogOpen && newFiles.length > 0) {\n          setFileToCrop(newFiles[0] ?? null);\n          setCropDialogOpen(true);\n        }\n      } else {\n        // Auto-compress immediately\n        setSourceFiles((prev) => {\n          const existing = prev.map((f) => f.name);\n          const filtered = newFiles.filter((f) => !existing.includes(f.name));\n          return [...prev, ...filtered];\n        });\n\n        if (newFiles.length > 0) {\n          setIsCompressing(true);\n          Promise.all(newFiles.map((file) => compressSingleFile(file)))\n            .then((compressed) => {\n              setCompressedFiles((prev) => {\n                const existingNames = prev.map((f) => f.name);\n                const newCompressed = compressed.filter(\n                  (f) => !existingNames.includes(f.name)\n                );\n\n                const nextFiles = [...prev, ...newCompressed];\n                return nextFiles;\n              });\n\n              if (autoUpload && (!enableCropping || skipCrop)) {\n                setTimeout(() => {\n                  setCompressedFiles((current) => {\n                    onConfirm?.(current);\n                    return current;\n                  });\n                }, 0);\n              }\n\n              const totalOriginal = compressed.reduce(\n                (acc, f) => acc + f.originalSize,\n                0\n              );\n              const totalCompressed = compressed.reduce(\n                (acc, f) => acc + f.compressedSize,\n                0\n              );\n              const saving =\n                ((totalOriginal - totalCompressed) / totalOriginal) * 100;\n\n              toast.success(\n                `Compressed ${compressed.length} image${compressed.length > 1 ? \"s\" : \"\"} - Saved ${saving.toFixed(1)}%`\n              );\n\n              onCompressed?.(compressed);\n            })\n            .catch(() => {\n              toast.error(\"Compression failed\");\n            })\n            .finally(() => {\n              setIsCompressing(false);\n            });\n        }\n      }\n    },\n    [\n      compressSingleFile,\n      cropDialogOpen,\n      enableCropping,\n      onCompressed,\n      autoUpload,\n      onConfirm,\n    ]\n  );\n\n  // biome-ignore lint/complexity/noExcessiveCognitiveComplexity: Complex logic\n  const compressAndUploadCrops = React.useCallback(\n    (allCrops: CropResult[]) => {\n      setIsCompressing(true);\n\n      Promise.all(\n        allCrops.map((cropResult) => {\n          const cropFile = new File([cropResult.blob], cropResult.file.name, {\n            type: cropResult.file.type,\n          });\n          return compressSingleFile(cropFile);\n        })\n      )\n        .then((compressed) => {\n          setCompressedFiles((prev) => {\n            const existingNames = prev.map((f) => f.name);\n            const newCompressed = compressed.filter(\n              (f) => !existingNames.includes(f.name)\n            );\n            return [...prev, ...newCompressed];\n          });\n\n          if (autoUpload) {\n            setTimeout(() => {\n              setCompressedFiles((current) => {\n                onConfirm?.(current);\n                return current;\n              });\n            }, 0);\n          }\n\n          setProcessedCrops([]);\n\n          const totalOriginal = compressed.reduce(\n            (acc, f) => acc + f.originalSize,\n            0\n          );\n          const totalCompressed = compressed.reduce(\n            (acc, f) => acc + f.compressedSize,\n            0\n          );\n          const saving =\n            ((totalOriginal - totalCompressed) / totalOriginal) * 100;\n\n          toast.success(\n            `Processed ${compressed.length} image${compressed.length > 1 ? \"s\" : \"\"} - Saved ${saving.toFixed(1)}%`\n          );\n\n          onCompressed?.(compressed);\n        })\n        .catch(() => {\n          toast.error(\"Compression failed\");\n        })\n        .finally(() => {\n          setIsCompressing(false);\n        });\n    },\n    [compressSingleFile, autoUpload, onConfirm, onCompressed]\n  );\n\n  // Handle crop complete\n  // biome-ignore lint/complexity/noExcessiveCognitiveComplexity: Complex logic\n  const handleCropComplete = React.useCallback(\n\n    (result: CropResult) => {\n      setProcessedCrops((prev) => [...prev, result]);\n      setCropQueue((prev) => prev.filter((f) => f.name !== result.file.name));\n\n      // Process next in queue\n      const remaining = cropQueue.filter((f) => f.name !== result.file.name);\n      if (remaining.length > 0) {\n        setFileToCrop(remaining[0] ?? null);\n        return;\n      }\n\n      setFileToCrop(null);\n      setCropDialogOpen(false);\n\n      // All images cropped, now compress\n      const allCrops = [...processedCrops, result];\n      compressAndUploadCrops(allCrops);\n    },\n    [cropQueue, processedCrops, compressAndUploadCrops]\n  );\n\n  // Handle skip crop\n  const handleSkipCrop = React.useCallback(() => {\n    if (!fileToCrop) {\n      return;\n    }\n\n    // Skip this file and move to next\n    setCropQueue((prev) => prev.filter((f) => f.name !== fileToCrop.name));\n\n    const remaining = cropQueue.filter((f) => f.name !== fileToCrop.name);\n    if (remaining.length > 0) {\n      setFileToCrop(remaining[0] ?? null);\n    } else {\n      setFileToCrop(null);\n      setCropDialogOpen(false);\n    }\n  }, [cropQueue, fileToCrop]);\n\n  // Remove compressed file\n  const removeCompressedFile = React.useCallback((index: number) => {\n    setCompressedFiles((prev) => {\n      const file = prev[index];\n      if (file?.preview) {\n        URL.revokeObjectURL(file.preview);\n      }\n      return prev.filter((_, idx) => idx !== index);\n    });\n  }, []);\n\n  // Download compressed file\n  const downloadFile = React.useCallback((file: CompressedFileWithPreview) => {\n    if (file.preview) {\n      const link = document.createElement(\"a\");\n      link.href = file.preview;\n      link.download = file.name;\n      link.click();\n    }\n  }, []);\n\n  // Clear all\n  const clearAll = React.useCallback(() => {\n    for (const f of compressedFiles) {\n      if (f.preview) {\n        URL.revokeObjectURL(f.preview);\n      }\n    }\n    for (const f of processedCrops) {\n      URL.revokeObjectURL(f.url);\n    }\n    setSourceFiles([]);\n    setCompressedFiles([]);\n    setCropQueue([]);\n    setProcessedCrops([]);\n  }, [compressedFiles, processedCrops]);\n\n  React.useImperativeHandle(ref, () => ({\n    addFiles: (files: File[]) => handleFileSelect(files, true),\n    clearFiles: clearAll,\n  }));\n\n  const { isDragging, handleDragOver, handleDragLeave, handleDrop } =\n    useDragDrop(handleFileSelect);\n\n  // Cleanup previews on unmount\n  React.useEffect(() => {\n    return () => {\n      for (const f of compressedFiles) {\n        if (f.preview) {\n          URL.revokeObjectURL(f.preview);\n        }\n      }\n      for (const f of processedCrops) {\n        URL.revokeObjectURL(f.url);\n      }\n    };\n  }, [compressedFiles, processedCrops]);\n\n  const hasFilesInQueue = cropQueue.length > 0 || processedCrops.length > 0;\n  const totalInQueue = cropQueue.length + processedCrops.length;\n  const hasInitialUrls = initialUrls && initialUrls.length > 0;\n  const hasAnyFiles =\n    compressedFiles.length > 0 || hasFilesInQueue || hasInitialUrls;\n\n  const combinedItems = React.useMemo<CombinedItem[]>(\n    () => [\n      ...(initialUrls || []).map((url) => ({\n        type: \"url\" as const,\n        id: url.id,\n        data: url,\n      })),\n      ...compressedFiles.map((file, index) => ({\n        type: \"file\" as const,\n        id: file.name || index,\n        data: file,\n      })),\n    ],\n    [initialUrls, compressedFiles]\n  );\n\n  return {\n    fileInputRef,\n    deleteTarget,\n    setDeleteTarget,\n    compressedFiles,\n    isCompressing,\n    isDragging,\n    isCompressionOptionsOpen,\n    setIsCompressionOptionsOpen,\n    compressionOptions,\n    setCompressionOptions,\n    enableCropping,\n    setEnableCropping,\n    cropDialogOpen,\n    setCropDialogOpen,\n    fileToCrop,\n    setFileToCrop,\n    cropQueue,\n    processedCrops,\n    previewOpen,\n    setPreviewOpen,\n    previewUrl,\n    setPreviewUrl,\n    previewName,\n    setPreviewName,\n    previewType,\n    setPreviewType,\n    handleFileSelect,\n    handleCropComplete,\n    handleSkipCrop,\n    removeCompressedFile,\n    downloadFile,\n    clearAll,\n    handleDragOver,\n    handleDragLeave,\n    handleDrop,\n    hasFilesInQueue,\n    totalInQueue,\n    hasInitialUrls,\n    hasAnyFiles,\n    combinedItems,\n  };\n}\n\nexport const ImageUploader = React.forwardRef<\n  ImageUploaderRef,\n  ImageUploaderProps\n>((props, ref) => {\n  const {\n    className,\n    showCompressionOptions = false,\n    showCompressionDetails = false,\n    showConfirmButton = true,\n    onConfirm,\n    isUploading = false,\n    initialUrls,\n    onRemoveUrl,\n    layout = \"grid\",\n  } = props;\n\n  const controller = useImageUploaderController(props, ref);\n\n  return (\n    <div className={cn(\"space-y-4\", className)}>\n      {/* Options */}\n      {showCompressionOptions && (\n        <CompressionOptionsPanel\n          enableCropping={controller.enableCropping}\n          isOpen={controller.isCompressionOptionsOpen}\n          onEnableCroppingChange={controller.setEnableCropping}\n          onOpenChange={controller.setIsCompressionOptionsOpen}\n          onOptionsChange={controller.setCompressionOptions}\n          options={controller.compressionOptions}\n        />\n      )}\n\n      {/* File Preview Dialog */}\n      <FilePreviewDialog\n        fileName={controller.previewName}\n        fileType={controller.previewType}\n        fileUrl={controller.previewUrl}\n        onOpenChange={controller.setPreviewOpen}\n        open={controller.previewOpen}\n      />\n\n      {/* Upload Area */}\n      {controller.hasAnyFiles ? (\n        <div className=\"space-y-3\">\n          {/* Crop queue indicator */}\n          {controller.hasFilesInQueue && (\n            <div className=\"flex items-center gap-3 rounded-lg border border-primary/20 bg-primary/5 p-3\">\n              <Crop className=\"h-5 w-5 animate-pulse text-primary\" />\n              <div className=\"flex flex-1 flex-col\">\n                <p className=\"font-medium text-sm\">\n                  Processing {controller.totalInQueue} image\n                  {controller.totalInQueue > 1 ? \"s\" : \"\"}\n                </p>\n                <p className=\"text-muted-foreground text-xs\">\n                  {controller.processedCrops.length} of{\" \"}\n                  {controller.totalInQueue} cropped\n                </p>\n              </div>\n              <Loader2 className=\"h-5 w-5 animate-spin text-primary\" />\n            </div>\n          )}\n\n          {/* Add more files button */}\n          <DropzonePrimitive\n            className=\"py-2\"\n            compact={true}\n            onClick={() => {\n              controller.fileInputRef.current?.click();\n            }}\n            onDragLeave={controller.handleDragLeave}\n            onDragOver={controller.handleDragOver}\n            onDrop={controller.handleDrop}\n            onKeyDown={(e) => {\n              if (e.key === \"Enter\" || e.key === \" \") {\n                e.preventDefault();\n                controller.fileInputRef.current?.click();\n              }\n            }}\n          >\n            <Plus className=\"mr-2 h-4 w-4\" />\n            Add more images\n            <input\n              accept=\"image/*\"\n              className=\"hidden\"\n              multiple\n              onChange={(e) => controller.handleFileSelect(e.target.files)}\n              ref={controller.fileInputRef}\n              type=\"file\"\n            />\n          </DropzonePrimitive>\n\n          {/* Images list (Unified) */}\n          {controller.hasAnyFiles &&\n            (controller.compressedFiles.length > 0 ||\n              controller.hasInitialUrls) && (\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between\">\n                  <h3 className=\"font-medium text-sm\">\n                    Images (\n                    {(initialUrls?.length || 0) +\n                      controller.compressedFiles.length}\n                    )\n                  </h3>\n                  {controller.compressedFiles.length > 0 && (\n                    <Button\n                      className=\"text-muted-foreground text-xs\"\n                      disabled={controller.isCompressing}\n                      onClick={controller.clearAll}\n                      size=\"sm\"\n                      variant=\"ghost\"\n                    >\n                      Clear new\n                    </Button>\n                  )}\n                </div>\n                <ImageGridList\n                  items={controller.combinedItems}\n                  layout={layout}\n                  onDownload={controller.downloadFile}\n                  onRemove={(item) => {\n                    if (item.type === \"url\") {\n                      controller.setDeleteTarget({\n                        type: \"url\",\n                        id: item.id,\n                      });\n                    } else {\n                      // Find index in compressedFiles\n                      const index = controller.compressedFiles.indexOf(\n                        item.data as CompressedFileWithPreview\n                      );\n                      controller.setDeleteTarget({\n                        type: \"file\",\n                        id: index,\n                      });\n                    }\n                  }}\n                  onView={(url, name, type) => {\n                    controller.setPreviewUrl(url);\n                    controller.setPreviewName(name);\n                    controller.setPreviewType(type);\n                    controller.setPreviewOpen(true);\n                  }}\n                  showCompressionDetails={showCompressionDetails}\n                />\n              </div>\n            )}\n\n          {/* Loading state */}\n          {controller.isCompressing && (\n            <div className=\"flex items-center justify-center gap-2 rounded-lg border bg-muted/30 py-4 text-muted-foreground text-sm\">\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\n              Processing images...\n            </div>\n          )}\n\n          {/* Confirm Button */}\n          {showConfirmButton &&\n            onConfirm &&\n            controller.compressedFiles.length > 0 && (\n              <Button\n                className=\"w-full\"\n                disabled={isUploading || controller.isCompressing}\n                onClick={() => onConfirm(controller.compressedFiles)}\n              >\n                {isUploading ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Uploading...\n                  </>\n                ) : (\n                  <>\n                    <Upload className=\"mr-2 h-4 w-4\" />\n                    Confirm Upload ({controller.compressedFiles.length})\n                  </>\n                )}\n              </Button>\n            )}\n        </div>\n      ) : (\n        <DropzonePrimitive\n          className={cn(\n            \"gap-4\",\n            controller.isDragging\n              ? \"border-primary bg-primary/5\"\n              : \"border-muted-foreground/25 hover:border-primary/50 hover:bg-muted/50\"\n          )}\n          compact={false}\n          onClick={() => {\n            controller.fileInputRef.current?.click();\n          }}\n          onDragLeave={controller.handleDragLeave}\n          onDragOver={controller.handleDragOver}\n          onDrop={controller.handleDrop}\n          onKeyDown={(e) => {\n            if (e.key === \"Enter\" || e.key === \" \") {\n              e.preventDefault();\n              controller.fileInputRef.current?.click();\n            }\n          }}\n        >\n          <FileImage className=\"h-10 w-10 text-muted-foreground\" />\n          <div className=\"space-y-1 text-center sm:text-left\">\n            <p className=\"font-medium text-lg\">Drop images here</p>\n            <p className=\"text-muted-foreground text-sm\">or click to browse</p>\n          </div>\n          <input\n            accept=\"image/*\"\n            className=\"hidden\"\n            multiple\n            onChange={(e) => controller.handleFileSelect(e.target.files)}\n            ref={controller.fileInputRef}\n            type=\"file\"\n          />\n        </DropzonePrimitive>\n      )}\n\n      {/* Crop Dialog */}\n      <ImageCropDialog\n        imageFile={controller.fileToCrop}\n        onCropComplete={controller.handleCropComplete}\n        onOpenChange={(open: boolean) => {\n          if (open) {\n            controller.setCropDialogOpen(open);\n          } else {\n            controller.handleSkipCrop();\n          }\n        }}\n        onSelectFile={controller.setFileToCrop}\n        open={controller.cropDialogOpen}\n        queue={controller.cropQueue}\n      />\n\n      <ConfirmDialog\n        description=\"This action cannot be undone.\"\n        onCancel={() => controller.setDeleteTarget(null)}\n        onConfirm={() => {\n          if (controller.deleteTarget?.type === \"file\") {\n            controller.removeCompressedFile(\n              controller.deleteTarget.id as number\n            );\n          } else if (controller.deleteTarget?.type === \"url\") {\n            onRemoveUrl?.(controller.deleteTarget.id as string);\n          }\n          controller.setDeleteTarget(null);\n        }}\n        onOpenChange={(open) => !open && controller.setDeleteTarget(null)}\n        open={!!controller.deleteTarget}\n        title=\"Are you sure?\"\n        variant=\"destructive\"\n      />\n    </div>\n  );\n});\ninterface ImagePreviewCardProps {\n  src: string;\n  alt: string;\n  onView?: () => void;\n  onDownload?: () => void;\n  onRemove?: () => void;\n  children?: React.ReactNode;\n  className?: string;\n}\n\nfunction ImagePreviewCard({\n  src,\n  alt,\n  onView,\n  onDownload,\n  onRemove,\n  children,\n  className,\n}: ImagePreviewCardProps) {\n  const containerRef = React.useRef<HTMLDivElement>(null);\n  const [width, setWidth] = React.useState(0);\n\n  React.useEffect(() => {\n    if (!containerRef.current) {\n      return;\n    }\n    const observer = new ResizeObserver((entries) => {\n      for (const entry of entries) {\n        setWidth(entry.contentRect.width);\n      }\n    });\n    observer.observe(containerRef.current);\n    return () => observer.disconnect();\n  }, []);\n\n  const isSmall = width < 100;\n\n  return (\n    <div\n      className={cn(\n        \"group relative aspect-square overflow-hidden rounded-lg border bg-card\",\n        className\n      )}\n      ref={containerRef}\n    >\n      {/* Thumbnail */}\n      {src ? (\n        // biome-ignore lint/correctness/useImageSize: Dynamic content\n        // biome-ignore lint/performance/noImgElement: Framework-agnostic\n        <img alt={alt} className=\"size-full object-cover\" src={src} />\n      ) : (\n        <div className=\"flex size-full items-center justify-center bg-muted\">\n          <FileImage className=\"h-8 w-8 text-muted-foreground\" />\n        </div>\n      )}\n\n      {/* Overlay on hover */}\n      <div className=\"absolute inset-0 flex flex-col justify-between bg-black/60 p-2 opacity-0 transition-opacity group-hover:opacity-100 data-[state=open]:opacity-100\">\n        {/* Actions at top */}\n        <div className=\"flex justify-end\">\n          {isSmall ? (\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button\n                  className=\"size-6 p-0 text-white hover:bg-white/20 hover:text-white\"\n                  size=\"icon\"\n                  variant=\"ghost\"\n                >\n                  <MoreVertical className=\"size-4\" />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                {onView && (\n                  <DropdownMenuItem onClick={onView}>\n                    <Eye className=\"mr-2 size-4\" /> View\n                  </DropdownMenuItem>\n                )}\n                {onDownload && (\n                  <DropdownMenuItem onClick={onDownload}>\n                    <Download className=\"mr-2 size-4\" /> Download\n                  </DropdownMenuItem>\n                )}\n                {onRemove && (\n                  <DropdownMenuItem\n                    className=\"text-destructive focus:text-destructive\"\n                    onClick={onRemove}\n                  >\n                    <X className=\"mr-2 size-4\" /> Remove\n                  </DropdownMenuItem>\n                )}\n              </DropdownMenuContent>\n            </DropdownMenu>\n          ) : (\n            <div className=\"flex justify-end gap-0.5\">\n              {onView && (\n                <Button\n                  className=\"size-6.5 p-0\"\n                  onClick={onView}\n                  size=\"icon\"\n                  title=\"View\"\n                  variant=\"secondary\"\n                >\n                  <Eye className=\"size-3.5\" />\n                </Button>\n              )}\n              {onDownload && (\n                <Button\n                  className=\"size-6.5 p-0\"\n                  onClick={onDownload}\n                  size=\"icon\"\n                  title=\"Download\"\n                  variant=\"secondary\"\n                >\n                  <Download className=\"size-3.5\" />\n                </Button>\n              )}\n              {onRemove && (\n                <Button\n                  className=\"size-6.5 p-0\"\n                  onClick={onRemove}\n                  size=\"icon\"\n                  title=\"Remove\"\n                  variant=\"destructive\"\n                >\n                  <X className=\"size-3.5\" />\n                </Button>\n              )}\n            </div>\n          )}\n        </div>\n\n        {/* File info at bottom */}\n        {children}\n      </div>\n\n      {/* Filename visible at bottom when not hovering/open */}\n      <div className=\"absolute right-0 bottom-0 left-0 rounded-b-lg bg-gradient-to-t from-black/70 to-transparent p-2 opacity-100 transition-opacity group-hover:opacity-0\">\n        <p className=\"truncate font-medium text-white text-xs\" title={alt}>\n          {alt}\n        </p>\n      </div>\n    </div>\n  );\n}\n\nfunction ImageUploaderItem({\n  item,\n  layout,\n  onDownload,\n  onRemove,\n  onView,\n  showCompressionDetails,\n}: {\n  item: CombinedItem;\n  layout: \"grid\" | \"carousel\";\n  onDownload: (file: CompressedFileWithPreview) => void;\n  onRemove: () => void;\n  onView: (url: string, name: string, type: string) => void;\n  showCompressionDetails: boolean;\n}) {\n  if (item.type === \"url\") {\n    const urlData = item.data as InitialUrl;\n    return (\n      <ImagePreviewCard\n        alt={urlData.name || \"\"}\n        className={layout === \"carousel\" ? \"aspect-video w-full\" : undefined}\n        onDownload={() => window.open(urlData.url, \"_blank\")}\n        onRemove={onRemove}\n        onView={() => onView(urlData.url, urlData.name || \"Preview\", \"image/*\")}\n        src={urlData.url}\n      />\n    );\n  }\n\n  const fileData = item.data as CompressedFileWithPreview;\n  const savings = (\n    ((fileData.originalSize - fileData.compressedSize) /\n      fileData.originalSize) *\n    100\n  ).toFixed(1);\n\n  return (\n    <ImagePreviewCard\n      alt={fileData.name}\n      className={layout === \"carousel\" ? \"aspect-video w-full\" : undefined}\n      onDownload={() => onDownload(fileData)}\n      onRemove={onRemove}\n      onView={\n        fileData.preview\n          ? () => onView(fileData.preview ?? \"\", fileData.name, fileData.type)\n          : undefined\n      }\n      src={fileData.preview || \"\"}\n    >\n      <div className=\"space-y-0.5\">\n        <p className=\"truncate font-medium text-[10px] text-white\">\n          {fileData.name}\n        </p>\n        <div className=\"flex justify-between text-[10px] text-white/80\">\n          <span>{formatBytes(fileData.compressedSize)}</span>\n          {showCompressionDetails && (\n            <Badge\n              className=\"text-xs\"\n              variant={Number.parseFloat(savings) > 0 ? \"default\" : \"secondary\"}\n            >\n              {Number.parseFloat(savings) > 0 ? `-${savings}%` : \"0%\"}\n            </Badge>\n          )}\n        </div>\n      </div>\n    </ImagePreviewCard>\n  );\n}\n\nasync function compressImageHelper(\n  file: File,\n  options: CompressionOptions,\n  // biome-ignore lint/suspicious/noExplicitAny: Dynamic import type is complex\n  browserImageCompression: any\n): Promise<CompressedFileWithPreview> {\n  if (!browserImageCompression) {\n    return Object.assign(file, {\n      originalSize: file.size,\n      compressedSize: file.size,\n      preview: URL.createObjectURL(file),\n    }) as CompressedFileWithPreview;\n  }\n\n  if (!file.type.startsWith(\"image/\")) {\n    return Object.assign(file, {\n      originalSize: file.size,\n      compressedSize: file.size,\n      preview: URL.createObjectURL(file),\n    }) as CompressedFileWithPreview;\n  }\n\n  try {\n    const opts = {\n      maxSizeMB: options.maxSizeMB,\n      maxWidthOrHeight: options.maxWidthOrHeight,\n      useWebWorker: options.useWebWorker,\n      alwaysKeepResolution: options.alwaysKeepResolution,\n    };\n    const blob = await browserImageCompression(file, opts);\n    const preview = URL.createObjectURL(blob);\n    const compressedFile = new window.File([blob], file.name, {\n      type: file.type,\n    }) as CompressedFileWithPreview;\n    compressedFile.originalSize = file.size;\n    compressedFile.compressedSize = compressedFile.size;\n    compressedFile.preview = preview;\n    return compressedFile;\n  } catch (e) {\n    console.error(\"Compression failed for\", file.name, e);\n    return Object.assign(file, {\n      originalSize: file.size,\n      compressedSize: file.size,\n      preview: URL.createObjectURL(file), // Fallback preview\n    }) as CompressedFileWithPreview;\n  }\n}\n"
      },
      "tags": [],
      "source": null
    },
    {
      "category": "lint/complexity/noExcessiveCognitiveComplexity",
      "severity": "error",
      "description": "Excessive complexity of 16 detected (max: 15).",
      "message": [
        {
          "elements": [],
          "content": "Excessive complexity of 16 detected (max: 15)."
        }
      ],
      "advices": {
        "advices": [
          {
            "log": [
              "info",
              [
                {
                  "elements": [],
                  "content": "Please refactor this function to reduce its complexity score from 16 to the max allowed complexity 15."
                }
              ]
            ]
          }
        ]
      },
      "verboseAdvices": { "advices": [] },
      "location": {
        "path": {
          "file": "packages\\ui\\src\\composed\\file-upload\\image-uploader.tsx"
        },
        "span": [21755, 21758],
        "sourceCode": "\"use client\";\n\n\nimport {\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselNext,\n  CarouselPrevious,\n} from \"@workspace/ui/components/carousel\";\nimport { cn } from \"@workspace/ui/lib/utils\";\n\nimport {\n  ChevronDown,\n  ChevronRight,\n  Crop,\n  Download,\n  Eye,\n  FileImage,\n  Loader2,\n  MoreVertical,\n  Plus,\n  Sparkles,\n  Upload,\n  X,\n} from \"lucide-react\";\nimport * as React from \"react\";\nimport { toast } from \"sonner\";\nimport { Badge } from \"../../components/badge\";\nimport { Button } from \"../../components/button\";\nimport { Checkbox } from \"../../components/checkbox\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"../../components/dropdown-menu\";\nimport { Label } from \"../../components/label\";\nimport { Slider } from \"../../components/slider\";\nimport { ConfirmDialog } from \"../confirm-dialog\"; // Import ConfirmDialog\nimport { FilePreviewDialog } from \"../file-preview/file-preview-dialog\";\nimport { DropzonePrimitive } from \"./dropzone-primitive\";\nimport { type CropResult, ImageCropDialog } from \"./image-crop-dialog\";\n\nexport interface CompressionOptions {\n  maxSizeMB: number;\n  maxWidthOrHeight: number;\n  useWebWorker: boolean;\n  alwaysKeepResolution: boolean;\n}\n\nexport interface CompressedFileWithPreview extends File {\n  originalSize: number;\n  compressedSize: number;\n  preview?: string;\n}\n\n/**\n * Pre-loaded image URL for edit mode display\n */\nexport interface InitialUrl {\n  id: string;\n  url: string;\n  name?: string;\n}\n\ntype CombinedItem =\n  | { type: \"url\"; id: string | number; data: InitialUrl }\n  | { type: \"file\"; id: string | number; data: CompressedFileWithPreview };\n\nexport interface ImageUploaderProps {\n  /**\n   * Callback when files are compressed\n   */\n  onCompressed?: (files: CompressedFileWithPreview[]) => void;\n\n  /**\n   * Callback when upload is requested/confirmed\n   */\n  onConfirm?: (files: CompressedFileWithPreview[]) => void;\n\n  /**\n   * Default compression options\n   */\n  defaultOptions?: Partial<CompressionOptions>;\n\n  /**\n   * Show upload/confirm button after compression\n   */\n  showConfirmButton?: boolean;\n  /**\n   * Show compression options UI\n   * @default false\n   */\n  showCompressionOptions?: boolean;\n\n  /**\n   * Enable cropping by default\n   * @default false\n   */\n  enableCropping?: boolean;\n\n  /**\n   * Automatically upload after compression (if cropping is disabled)\n   * @default false\n   */\n  autoUpload?: boolean;\n\n  /**\n   * Is currently uploading\n   */\n  isUploading?: boolean;\n\n  className?: string;\n  showCompressionDetails?: boolean;\n  /**\n   * Pre-loaded image URLs for edit mode (display-only with remove)\n   */\n  initialUrls?: InitialUrl[];\n\n  /**\n   * Callback when a pre-loaded URL is removed\n   */\n  onRemoveUrl?: (id: string) => void;\n\n  /**\n   * Layout mode for displaying images\n   * @default \"grid\"\n   */\n  layout?: \"grid\" | \"carousel\";\n}\n\n// Format bytes to human readable\nfunction formatBytes(bytes: number): string {\n  if (bytes === 0) {\n    return \"0 B\";\n  }\n  const k = 1024;\n  const sizes = [\"B\", \"KB\", \"MB\", \"GB\"];\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n  return `${Number.parseFloat((bytes / k ** i).toFixed(1))} ${sizes[i]}`;\n}\n\nexport interface ImageUploaderRef {\n  addFiles: (files: File[]) => void;\n  clearFiles: () => void;\n}\n\ninterface CompressionOptionsPanelProps {\n  isOpen: boolean;\n  onOpenChange: (open: boolean) => void;\n  enableCropping: boolean;\n  onEnableCroppingChange: (enabled: boolean) => void;\n  options: CompressionOptions;\n  onOptionsChange: (options: CompressionOptions) => void;\n}\n\nfunction CompressionOptionsPanel({\n  isOpen,\n  onOpenChange,\n  enableCropping,\n  onEnableCroppingChange,\n  options,\n  onOptionsChange,\n}: CompressionOptionsPanelProps) {\n  return (\n    <div className=\"rounded-lg border bg-muted/30 p-4\">\n      <button\n        className=\"flex w-full items-center justify-between font-medium text-sm\"\n        onClick={() => onOpenChange(!isOpen)}\n        type=\"button\"\n      >\n        <span>Compression Options</span>\n        {isOpen ? (\n          <ChevronDown className=\"h-4 w-4\" />\n        ) : (\n          <ChevronRight className=\"h-4 w-4\" />\n        )}\n      </button>\n\n      {isOpen && (\n        <div className=\"mt-4 space-y-4\">\n          {/* Enable cropping toggle */}\n          <div className=\"flex items-center gap-3 rounded-lg border border-primary/20 bg-primary/5 p-3\">\n            <Sparkles className=\"h-5 w-5 text-primary\" />\n            <div className=\"flex flex-1 flex-col gap-1\">\n              <Label className=\"cursor-pointer\" htmlFor=\"enable-cropping\">\n                Enable image cropping\n              </Label>\n              <p className=\"text-muted-foreground text-xs\">\n                Crop, rotate, and flip images before compression\n              </p>\n            </div>\n            <Checkbox\n              checked={enableCropping}\n              id=\"enable-cropping\"\n              onCheckedChange={(checked: boolean) =>\n                onEnableCroppingChange(checked)\n              }\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center justify-between\">\n              <Label htmlFor=\"maxSizeMB\">Max file size (MB)</Label>\n              <span className=\"text-muted-foreground text-sm\">\n                {options.maxSizeMB} MB\n              </span>\n            </div>\n            <Slider\n              id=\"maxSizeMB\"\n              max={10}\n              min={0.1}\n              onValueChange={([value]: number[]) => {\n                if (value !== undefined) {\n                  onOptionsChange({\n                    ...options,\n                    maxSizeMB: value,\n                  });\n                }\n              }}\n              step={0.1}\n              value={[options.maxSizeMB]}\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center justify-between\">\n              <Label htmlFor=\"maxDimension\">Max width/height (px)</Label>\n              <span className=\"text-muted-foreground text-sm\">\n                {options.maxWidthOrHeight} px\n              </span>\n            </div>\n            <Slider\n              id=\"maxDimension\"\n              max={4096}\n              min={480}\n              onValueChange={([value]: number[]) => {\n                if (value !== undefined) {\n                  onOptionsChange({\n                    ...options,\n                    maxWidthOrHeight: value,\n                  });\n                }\n              }}\n              step={32}\n              value={[options.maxWidthOrHeight]}\n            />\n          </div>\n\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center gap-3\">\n              <Checkbox\n                checked={options.useWebWorker}\n                onCheckedChange={(checked: boolean) =>\n                  onOptionsChange({\n                    ...options,\n                    useWebWorker: checked,\n                  })\n                }\n              />\n              <Label className=\"cursor-pointer\">Use Web Worker</Label>\n            </div>\n\n            <div className=\"flex items-center gap-3\">\n              <Checkbox\n                checked={options.alwaysKeepResolution}\n                onCheckedChange={(checked: boolean) =>\n                  onOptionsChange({\n                    ...options,\n                    alwaysKeepResolution: checked,\n                  })\n                }\n              />\n              <Label className=\"cursor-pointer\">Keep resolution</Label>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\ninterface ImageGridListProps {\n  items: CombinedItem[];\n  layout: \"grid\" | \"carousel\";\n  onRemove: (item: CombinedItem) => void;\n  onDownload: (file: CompressedFileWithPreview) => void;\n  onView: (url: string, name: string, type: string) => void;\n  showCompressionDetails: boolean;\n}\n\nfunction ImageGridList({\n  items,\n  layout,\n  onRemove,\n  onDownload,\n  onView,\n  showCompressionDetails,\n}: ImageGridListProps) {\n  const renderItem = (item: CombinedItem) => (\n    <ImageUploaderItem\n      item={item}\n      key={item.id}\n      layout={layout}\n      onDownload={onDownload}\n      onRemove={() => onRemove(item)}\n      onView={onView}\n      showCompressionDetails={showCompressionDetails}\n    />\n  );\n\n  if (layout === \"grid\") {\n    return (\n      <div className=\"grid grid-cols-3 gap-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6\">\n        {items.map((item) => renderItem(item))}\n      </div>\n    );\n  }\n\n  return (\n    <Carousel\n      className=\"mx-auto min-h-[120px] w-full\"\n      opts={{ align: \"start\" }}\n    >\n      <CarouselContent className=\"-ml-2 md:-ml-4\">\n        {items.map((item) => (\n          <CarouselItem className=\"basis-full pl-2 md:pl-4\" key={item.id}>\n            {renderItem(item)}\n          </CarouselItem>\n        ))}\n      </CarouselContent>\n      <CarouselPrevious className=\"left-2 bg-background/80 hover:bg-background\" />\n      <CarouselNext className=\"right-2 bg-background/80 hover:bg-background\" />\n    </Carousel>\n  );\n}\n\nfunction useDragDrop(\n  onFilesSelected: (files: FileList | File[] | null) => void\n) {\n  const [isDragging, setIsDragging] = React.useState(false);\n\n  const handleDragOver = React.useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(true);\n  }, []);\n\n  const handleDragLeave = React.useCallback(() => {\n    setIsDragging(false);\n  }, []);\n\n  const handleDrop = React.useCallback(\n    (e: React.DragEvent) => {\n      e.preventDefault();\n      setIsDragging(false);\n      onFilesSelected(e.dataTransfer.files);\n    },\n    [onFilesSelected]\n  );\n\n  return { isDragging, handleDragOver, handleDragLeave, handleDrop };\n}\n\n// biome-ignore lint/complexity/noExcessiveCognitiveComplexity: Controller manages complex file upload state and workflows\nfunction useImageUploaderController(\n  props: ImageUploaderProps,\n  ref: React.ForwardedRef<ImageUploaderRef>\n) {\n  const {\n    onCompressed,\n    onConfirm,\n    defaultOptions,\n    enableCropping: defaultEnableCropping = false,\n    autoUpload = true,\n    initialUrls,\n  } = props;\n\n  const fileInputRef = React.useRef<HTMLInputElement>(null);\n  const [deleteTarget, setDeleteTarget] = React.useState<{\n    type: \"file\" | \"url\";\n    id: string | number;\n  } | null>(null);\n  const [_sourceFiles, setSourceFiles] = React.useState<File[]>([]);\n  const [compressedFiles, setCompressedFiles] = React.useState<\n    CompressedFileWithPreview[]\n  >([]);\n  const [isCompressing, setIsCompressing] = React.useState(false);\n\n  const [isCompressionOptionsOpen, setIsCompressionOptionsOpen] =\n    React.useState(false);\n  const [compressionOptions, setCompressionOptions] =\n    React.useState<CompressionOptions>({\n      maxSizeMB: defaultOptions?.maxSizeMB ?? 1,\n      maxWidthOrHeight: defaultOptions?.maxWidthOrHeight ?? 1920,\n      useWebWorker: defaultOptions?.useWebWorker ?? true,\n      alwaysKeepResolution: defaultOptions?.alwaysKeepResolution ?? false,\n    });\n\n  // Cropping state\n  const [enableCropping, setEnableCropping] = React.useState(\n    defaultEnableCropping\n  );\n  const [cropDialogOpen, setCropDialogOpen] = React.useState(false);\n  const [fileToCrop, setFileToCrop] = React.useState<File | null>(null);\n  const [cropQueue, setCropQueue] = React.useState<File[]>([]);\n  const [processedCrops, setProcessedCrops] = React.useState<CropResult[]>([]);\n\n  // Preview state\n  const [previewOpen, setPreviewOpen] = React.useState(false);\n  const [previewUrl, setPreviewUrl] = React.useState(\"\");\n  const [previewName, setPreviewName] = React.useState(\"\");\n  const [previewType, setPreviewType] = React.useState(\"\");\n\n  // Dynamically import browser-image-compression to avoid SSR issues\n  const [browserImageCompression, setBrowserImageCompression] = React.useState<\n    typeof import(\"browser-image-compression\").default | null\n  >(null);\n\n  React.useEffect(() => {\n    setEnableCropping(defaultEnableCropping);\n  }, [defaultEnableCropping]);\n\n  React.useEffect(() => {\n    import(\"browser-image-compression\").then((module) => {\n      setBrowserImageCompression(() => module.default);\n    });\n  }, []);\n\n  // Compress a single file\n  const compressSingleFile = React.useCallback(\n    (file: File) => {\n      return compressImageHelper(\n        file,\n        compressionOptions,\n        browserImageCompression\n      );\n    },\n    [browserImageCompression, compressionOptions]\n  );\n\n  // Handle file selection\n  const handleFileSelect = React.useCallback(\n    // biome-ignore lint/complexity/noExcessiveCognitiveComplexity: File selection validation logic is inherently complex\n    (files: FileList | File[] | null, skipCrop = false) => {\n      if (!files) {\n        return;\n      }\n\n      const newFiles = Array.from(files).filter((f) =>\n        f.type.startsWith(\"image/\")\n      );\n\n      if (newFiles.length === 0) {\n        toast.error(\"Please select image files only\");\n        return;\n      }\n\n      if (enableCropping && !skipCrop) {\n        // Add to queue for cropping\n        setCropQueue((prev) => {\n          const existing = prev.map((f) => f.name);\n          const filtered = newFiles.filter((f) => !existing.includes(f.name));\n          return [...prev, ...filtered];\n        });\n\n        // Start cropping if dialog is closed\n        if (!cropDialogOpen && newFiles.length > 0) {\n          setFileToCrop(newFiles[0] ?? null);\n          setCropDialogOpen(true);\n        }\n      } else {\n        // Auto-compress immediately\n        setSourceFiles((prev) => {\n          const existing = prev.map((f) => f.name);\n          const filtered = newFiles.filter((f) => !existing.includes(f.name));\n          return [...prev, ...filtered];\n        });\n\n        if (newFiles.length > 0) {\n          setIsCompressing(true);\n          Promise.all(newFiles.map((file) => compressSingleFile(file)))\n            .then((compressed) => {\n              setCompressedFiles((prev) => {\n                const existingNames = prev.map((f) => f.name);\n                const newCompressed = compressed.filter(\n                  (f) => !existingNames.includes(f.name)\n                );\n\n                const nextFiles = [...prev, ...newCompressed];\n                return nextFiles;\n              });\n\n              if (autoUpload && (!enableCropping || skipCrop)) {\n                setTimeout(() => {\n                  setCompressedFiles((current) => {\n                    onConfirm?.(current);\n                    return current;\n                  });\n                }, 0);\n              }\n\n              const totalOriginal = compressed.reduce(\n                (acc, f) => acc + f.originalSize,\n                0\n              );\n              const totalCompressed = compressed.reduce(\n                (acc, f) => acc + f.compressedSize,\n                0\n              );\n              const saving =\n                ((totalOriginal - totalCompressed) / totalOriginal) * 100;\n\n              toast.success(\n                `Compressed ${compressed.length} image${compressed.length > 1 ? \"s\" : \"\"} - Saved ${saving.toFixed(1)}%`\n              );\n\n              onCompressed?.(compressed);\n            })\n            .catch(() => {\n              toast.error(\"Compression failed\");\n            })\n            .finally(() => {\n              setIsCompressing(false);\n            });\n        }\n      }\n    },\n    [\n      compressSingleFile,\n      cropDialogOpen,\n      enableCropping,\n      onCompressed,\n      autoUpload,\n      onConfirm,\n    ]\n  );\n\n  // biome-ignore lint/complexity/noExcessiveCognitiveComplexity: Complex logic\n  const compressAndUploadCrops = React.useCallback(\n    (allCrops: CropResult[]) => {\n      setIsCompressing(true);\n\n      Promise.all(\n        allCrops.map((cropResult) => {\n          const cropFile = new File([cropResult.blob], cropResult.file.name, {\n            type: cropResult.file.type,\n          });\n          return compressSingleFile(cropFile);\n        })\n      )\n        .then((compressed) => {\n          setCompressedFiles((prev) => {\n            const existingNames = prev.map((f) => f.name);\n            const newCompressed = compressed.filter(\n              (f) => !existingNames.includes(f.name)\n            );\n            return [...prev, ...newCompressed];\n          });\n\n          if (autoUpload) {\n            setTimeout(() => {\n              setCompressedFiles((current) => {\n                onConfirm?.(current);\n                return current;\n              });\n            }, 0);\n          }\n\n          setProcessedCrops([]);\n\n          const totalOriginal = compressed.reduce(\n            (acc, f) => acc + f.originalSize,\n            0\n          );\n          const totalCompressed = compressed.reduce(\n            (acc, f) => acc + f.compressedSize,\n            0\n          );\n          const saving =\n            ((totalOriginal - totalCompressed) / totalOriginal) * 100;\n\n          toast.success(\n            `Processed ${compressed.length} image${compressed.length > 1 ? \"s\" : \"\"} - Saved ${saving.toFixed(1)}%`\n          );\n\n          onCompressed?.(compressed);\n        })\n        .catch(() => {\n          toast.error(\"Compression failed\");\n        })\n        .finally(() => {\n          setIsCompressing(false);\n        });\n    },\n    [compressSingleFile, autoUpload, onConfirm, onCompressed]\n  );\n\n  // Handle crop complete\n  // biome-ignore lint/complexity/noExcessiveCognitiveComplexity: Complex logic\n  const handleCropComplete = React.useCallback(\n\n    (result: CropResult) => {\n      setProcessedCrops((prev) => [...prev, result]);\n      setCropQueue((prev) => prev.filter((f) => f.name !== result.file.name));\n\n      // Process next in queue\n      const remaining = cropQueue.filter((f) => f.name !== result.file.name);\n      if (remaining.length > 0) {\n        setFileToCrop(remaining[0] ?? null);\n        return;\n      }\n\n      setFileToCrop(null);\n      setCropDialogOpen(false);\n\n      // All images cropped, now compress\n      const allCrops = [...processedCrops, result];\n      compressAndUploadCrops(allCrops);\n    },\n    [cropQueue, processedCrops, compressAndUploadCrops]\n  );\n\n  // Handle skip crop\n  const handleSkipCrop = React.useCallback(() => {\n    if (!fileToCrop) {\n      return;\n    }\n\n    // Skip this file and move to next\n    setCropQueue((prev) => prev.filter((f) => f.name !== fileToCrop.name));\n\n    const remaining = cropQueue.filter((f) => f.name !== fileToCrop.name);\n    if (remaining.length > 0) {\n      setFileToCrop(remaining[0] ?? null);\n    } else {\n      setFileToCrop(null);\n      setCropDialogOpen(false);\n    }\n  }, [cropQueue, fileToCrop]);\n\n  // Remove compressed file\n  const removeCompressedFile = React.useCallback((index: number) => {\n    setCompressedFiles((prev) => {\n      const file = prev[index];\n      if (file?.preview) {\n        URL.revokeObjectURL(file.preview);\n      }\n      return prev.filter((_, idx) => idx !== index);\n    });\n  }, []);\n\n  // Download compressed file\n  const downloadFile = React.useCallback((file: CompressedFileWithPreview) => {\n    if (file.preview) {\n      const link = document.createElement(\"a\");\n      link.href = file.preview;\n      link.download = file.name;\n      link.click();\n    }\n  }, []);\n\n  // Clear all\n  const clearAll = React.useCallback(() => {\n    for (const f of compressedFiles) {\n      if (f.preview) {\n        URL.revokeObjectURL(f.preview);\n      }\n    }\n    for (const f of processedCrops) {\n      URL.revokeObjectURL(f.url);\n    }\n    setSourceFiles([]);\n    setCompressedFiles([]);\n    setCropQueue([]);\n    setProcessedCrops([]);\n  }, [compressedFiles, processedCrops]);\n\n  React.useImperativeHandle(ref, () => ({\n    addFiles: (files: File[]) => handleFileSelect(files, true),\n    clearFiles: clearAll,\n  }));\n\n  const { isDragging, handleDragOver, handleDragLeave, handleDrop } =\n    useDragDrop(handleFileSelect);\n\n  // Cleanup previews on unmount\n  React.useEffect(() => {\n    return () => {\n      for (const f of compressedFiles) {\n        if (f.preview) {\n          URL.revokeObjectURL(f.preview);\n        }\n      }\n      for (const f of processedCrops) {\n        URL.revokeObjectURL(f.url);\n      }\n    };\n  }, [compressedFiles, processedCrops]);\n\n  const hasFilesInQueue = cropQueue.length > 0 || processedCrops.length > 0;\n  const totalInQueue = cropQueue.length + processedCrops.length;\n  const hasInitialUrls = initialUrls && initialUrls.length > 0;\n  const hasAnyFiles =\n    compressedFiles.length > 0 || hasFilesInQueue || hasInitialUrls;\n\n  const combinedItems = React.useMemo<CombinedItem[]>(\n    () => [\n      ...(initialUrls || []).map((url) => ({\n        type: \"url\" as const,\n        id: url.id,\n        data: url,\n      })),\n      ...compressedFiles.map((file, index) => ({\n        type: \"file\" as const,\n        id: file.name || index,\n        data: file,\n      })),\n    ],\n    [initialUrls, compressedFiles]\n  );\n\n  return {\n    fileInputRef,\n    deleteTarget,\n    setDeleteTarget,\n    compressedFiles,\n    isCompressing,\n    isDragging,\n    isCompressionOptionsOpen,\n    setIsCompressionOptionsOpen,\n    compressionOptions,\n    setCompressionOptions,\n    enableCropping,\n    setEnableCropping,\n    cropDialogOpen,\n    setCropDialogOpen,\n    fileToCrop,\n    setFileToCrop,\n    cropQueue,\n    processedCrops,\n    previewOpen,\n    setPreviewOpen,\n    previewUrl,\n    setPreviewUrl,\n    previewName,\n    setPreviewName,\n    previewType,\n    setPreviewType,\n    handleFileSelect,\n    handleCropComplete,\n    handleSkipCrop,\n    removeCompressedFile,\n    downloadFile,\n    clearAll,\n    handleDragOver,\n    handleDragLeave,\n    handleDrop,\n    hasFilesInQueue,\n    totalInQueue,\n    hasInitialUrls,\n    hasAnyFiles,\n    combinedItems,\n  };\n}\n\nexport const ImageUploader = React.forwardRef<\n  ImageUploaderRef,\n  ImageUploaderProps\n>((props, ref) => {\n  const {\n    className,\n    showCompressionOptions = false,\n    showCompressionDetails = false,\n    showConfirmButton = true,\n    onConfirm,\n    isUploading = false,\n    initialUrls,\n    onRemoveUrl,\n    layout = \"grid\",\n  } = props;\n\n  const controller = useImageUploaderController(props, ref);\n\n  return (\n    <div className={cn(\"space-y-4\", className)}>\n      {/* Options */}\n      {showCompressionOptions && (\n        <CompressionOptionsPanel\n          enableCropping={controller.enableCropping}\n          isOpen={controller.isCompressionOptionsOpen}\n          onEnableCroppingChange={controller.setEnableCropping}\n          onOpenChange={controller.setIsCompressionOptionsOpen}\n          onOptionsChange={controller.setCompressionOptions}\n          options={controller.compressionOptions}\n        />\n      )}\n\n      {/* File Preview Dialog */}\n      <FilePreviewDialog\n        fileName={controller.previewName}\n        fileType={controller.previewType}\n        fileUrl={controller.previewUrl}\n        onOpenChange={controller.setPreviewOpen}\n        open={controller.previewOpen}\n      />\n\n      {/* Upload Area */}\n      {controller.hasAnyFiles ? (\n        <div className=\"space-y-3\">\n          {/* Crop queue indicator */}\n          {controller.hasFilesInQueue && (\n            <div className=\"flex items-center gap-3 rounded-lg border border-primary/20 bg-primary/5 p-3\">\n              <Crop className=\"h-5 w-5 animate-pulse text-primary\" />\n              <div className=\"flex flex-1 flex-col\">\n                <p className=\"font-medium text-sm\">\n                  Processing {controller.totalInQueue} image\n                  {controller.totalInQueue > 1 ? \"s\" : \"\"}\n                </p>\n                <p className=\"text-muted-foreground text-xs\">\n                  {controller.processedCrops.length} of{\" \"}\n                  {controller.totalInQueue} cropped\n                </p>\n              </div>\n              <Loader2 className=\"h-5 w-5 animate-spin text-primary\" />\n            </div>\n          )}\n\n          {/* Add more files button */}\n          <DropzonePrimitive\n            className=\"py-2\"\n            compact={true}\n            onClick={() => {\n              controller.fileInputRef.current?.click();\n            }}\n            onDragLeave={controller.handleDragLeave}\n            onDragOver={controller.handleDragOver}\n            onDrop={controller.handleDrop}\n            onKeyDown={(e) => {\n              if (e.key === \"Enter\" || e.key === \" \") {\n                e.preventDefault();\n                controller.fileInputRef.current?.click();\n              }\n            }}\n          >\n            <Plus className=\"mr-2 h-4 w-4\" />\n            Add more images\n            <input\n              accept=\"image/*\"\n              className=\"hidden\"\n              multiple\n              onChange={(e) => controller.handleFileSelect(e.target.files)}\n              ref={controller.fileInputRef}\n              type=\"file\"\n            />\n          </DropzonePrimitive>\n\n          {/* Images list (Unified) */}\n          {controller.hasAnyFiles &&\n            (controller.compressedFiles.length > 0 ||\n              controller.hasInitialUrls) && (\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between\">\n                  <h3 className=\"font-medium text-sm\">\n                    Images (\n                    {(initialUrls?.length || 0) +\n                      controller.compressedFiles.length}\n                    )\n                  </h3>\n                  {controller.compressedFiles.length > 0 && (\n                    <Button\n                      className=\"text-muted-foreground text-xs\"\n                      disabled={controller.isCompressing}\n                      onClick={controller.clearAll}\n                      size=\"sm\"\n                      variant=\"ghost\"\n                    >\n                      Clear new\n                    </Button>\n                  )}\n                </div>\n                <ImageGridList\n                  items={controller.combinedItems}\n                  layout={layout}\n                  onDownload={controller.downloadFile}\n                  onRemove={(item) => {\n                    if (item.type === \"url\") {\n                      controller.setDeleteTarget({\n                        type: \"url\",\n                        id: item.id,\n                      });\n                    } else {\n                      // Find index in compressedFiles\n                      const index = controller.compressedFiles.indexOf(\n                        item.data as CompressedFileWithPreview\n                      );\n                      controller.setDeleteTarget({\n                        type: \"file\",\n                        id: index,\n                      });\n                    }\n                  }}\n                  onView={(url, name, type) => {\n                    controller.setPreviewUrl(url);\n                    controller.setPreviewName(name);\n                    controller.setPreviewType(type);\n                    controller.setPreviewOpen(true);\n                  }}\n                  showCompressionDetails={showCompressionDetails}\n                />\n              </div>\n            )}\n\n          {/* Loading state */}\n          {controller.isCompressing && (\n            <div className=\"flex items-center justify-center gap-2 rounded-lg border bg-muted/30 py-4 text-muted-foreground text-sm\">\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\n              Processing images...\n            </div>\n          )}\n\n          {/* Confirm Button */}\n          {showConfirmButton &&\n            onConfirm &&\n            controller.compressedFiles.length > 0 && (\n              <Button\n                className=\"w-full\"\n                disabled={isUploading || controller.isCompressing}\n                onClick={() => onConfirm(controller.compressedFiles)}\n              >\n                {isUploading ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Uploading...\n                  </>\n                ) : (\n                  <>\n                    <Upload className=\"mr-2 h-4 w-4\" />\n                    Confirm Upload ({controller.compressedFiles.length})\n                  </>\n                )}\n              </Button>\n            )}\n        </div>\n      ) : (\n        <DropzonePrimitive\n          className={cn(\n            \"gap-4\",\n            controller.isDragging\n              ? \"border-primary bg-primary/5\"\n              : \"border-muted-foreground/25 hover:border-primary/50 hover:bg-muted/50\"\n          )}\n          compact={false}\n          onClick={() => {\n            controller.fileInputRef.current?.click();\n          }}\n          onDragLeave={controller.handleDragLeave}\n          onDragOver={controller.handleDragOver}\n          onDrop={controller.handleDrop}\n          onKeyDown={(e) => {\n            if (e.key === \"Enter\" || e.key === \" \") {\n              e.preventDefault();\n              controller.fileInputRef.current?.click();\n            }\n          }}\n        >\n          <FileImage className=\"h-10 w-10 text-muted-foreground\" />\n          <div className=\"space-y-1 text-center sm:text-left\">\n            <p className=\"font-medium text-lg\">Drop images here</p>\n            <p className=\"text-muted-foreground text-sm\">or click to browse</p>\n          </div>\n          <input\n            accept=\"image/*\"\n            className=\"hidden\"\n            multiple\n            onChange={(e) => controller.handleFileSelect(e.target.files)}\n            ref={controller.fileInputRef}\n            type=\"file\"\n          />\n        </DropzonePrimitive>\n      )}\n\n      {/* Crop Dialog */}\n      <ImageCropDialog\n        imageFile={controller.fileToCrop}\n        onCropComplete={controller.handleCropComplete}\n        onOpenChange={(open: boolean) => {\n          if (open) {\n            controller.setCropDialogOpen(open);\n          } else {\n            controller.handleSkipCrop();\n          }\n        }}\n        onSelectFile={controller.setFileToCrop}\n        open={controller.cropDialogOpen}\n        queue={controller.cropQueue}\n      />\n\n      <ConfirmDialog\n        description=\"This action cannot be undone.\"\n        onCancel={() => controller.setDeleteTarget(null)}\n        onConfirm={() => {\n          if (controller.deleteTarget?.type === \"file\") {\n            controller.removeCompressedFile(\n              controller.deleteTarget.id as number\n            );\n          } else if (controller.deleteTarget?.type === \"url\") {\n            onRemoveUrl?.(controller.deleteTarget.id as string);\n          }\n          controller.setDeleteTarget(null);\n        }}\n        onOpenChange={(open) => !open && controller.setDeleteTarget(null)}\n        open={!!controller.deleteTarget}\n        title=\"Are you sure?\"\n        variant=\"destructive\"\n      />\n    </div>\n  );\n});\ninterface ImagePreviewCardProps {\n  src: string;\n  alt: string;\n  onView?: () => void;\n  onDownload?: () => void;\n  onRemove?: () => void;\n  children?: React.ReactNode;\n  className?: string;\n}\n\nfunction ImagePreviewCard({\n  src,\n  alt,\n  onView,\n  onDownload,\n  onRemove,\n  children,\n  className,\n}: ImagePreviewCardProps) {\n  const containerRef = React.useRef<HTMLDivElement>(null);\n  const [width, setWidth] = React.useState(0);\n\n  React.useEffect(() => {\n    if (!containerRef.current) {\n      return;\n    }\n    const observer = new ResizeObserver((entries) => {\n      for (const entry of entries) {\n        setWidth(entry.contentRect.width);\n      }\n    });\n    observer.observe(containerRef.current);\n    return () => observer.disconnect();\n  }, []);\n\n  const isSmall = width < 100;\n\n  return (\n    <div\n      className={cn(\n        \"group relative aspect-square overflow-hidden rounded-lg border bg-card\",\n        className\n      )}\n      ref={containerRef}\n    >\n      {/* Thumbnail */}\n      {src ? (\n        // biome-ignore lint/correctness/useImageSize: Dynamic content\n        // biome-ignore lint/performance/noImgElement: Framework-agnostic\n        <img alt={alt} className=\"size-full object-cover\" src={src} />\n      ) : (\n        <div className=\"flex size-full items-center justify-center bg-muted\">\n          <FileImage className=\"h-8 w-8 text-muted-foreground\" />\n        </div>\n      )}\n\n      {/* Overlay on hover */}\n      <div className=\"absolute inset-0 flex flex-col justify-between bg-black/60 p-2 opacity-0 transition-opacity group-hover:opacity-100 data-[state=open]:opacity-100\">\n        {/* Actions at top */}\n        <div className=\"flex justify-end\">\n          {isSmall ? (\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button\n                  className=\"size-6 p-0 text-white hover:bg-white/20 hover:text-white\"\n                  size=\"icon\"\n                  variant=\"ghost\"\n                >\n                  <MoreVertical className=\"size-4\" />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                {onView && (\n                  <DropdownMenuItem onClick={onView}>\n                    <Eye className=\"mr-2 size-4\" /> View\n                  </DropdownMenuItem>\n                )}\n                {onDownload && (\n                  <DropdownMenuItem onClick={onDownload}>\n                    <Download className=\"mr-2 size-4\" /> Download\n                  </DropdownMenuItem>\n                )}\n                {onRemove && (\n                  <DropdownMenuItem\n                    className=\"text-destructive focus:text-destructive\"\n                    onClick={onRemove}\n                  >\n                    <X className=\"mr-2 size-4\" /> Remove\n                  </DropdownMenuItem>\n                )}\n              </DropdownMenuContent>\n            </DropdownMenu>\n          ) : (\n            <div className=\"flex justify-end gap-0.5\">\n              {onView && (\n                <Button\n                  className=\"size-6.5 p-0\"\n                  onClick={onView}\n                  size=\"icon\"\n                  title=\"View\"\n                  variant=\"secondary\"\n                >\n                  <Eye className=\"size-3.5\" />\n                </Button>\n              )}\n              {onDownload && (\n                <Button\n                  className=\"size-6.5 p-0\"\n                  onClick={onDownload}\n                  size=\"icon\"\n                  title=\"Download\"\n                  variant=\"secondary\"\n                >\n                  <Download className=\"size-3.5\" />\n                </Button>\n              )}\n              {onRemove && (\n                <Button\n                  className=\"size-6.5 p-0\"\n                  onClick={onRemove}\n                  size=\"icon\"\n                  title=\"Remove\"\n                  variant=\"destructive\"\n                >\n                  <X className=\"size-3.5\" />\n                </Button>\n              )}\n            </div>\n          )}\n        </div>\n\n        {/* File info at bottom */}\n        {children}\n      </div>\n\n      {/* Filename visible at bottom when not hovering/open */}\n      <div className=\"absolute right-0 bottom-0 left-0 rounded-b-lg bg-gradient-to-t from-black/70 to-transparent p-2 opacity-100 transition-opacity group-hover:opacity-0\">\n        <p className=\"truncate font-medium text-white text-xs\" title={alt}>\n          {alt}\n        </p>\n      </div>\n    </div>\n  );\n}\n\nfunction ImageUploaderItem({\n  item,\n  layout,\n  onDownload,\n  onRemove,\n  onView,\n  showCompressionDetails,\n}: {\n  item: CombinedItem;\n  layout: \"grid\" | \"carousel\";\n  onDownload: (file: CompressedFileWithPreview) => void;\n  onRemove: () => void;\n  onView: (url: string, name: string, type: string) => void;\n  showCompressionDetails: boolean;\n}) {\n  if (item.type === \"url\") {\n    const urlData = item.data as InitialUrl;\n    return (\n      <ImagePreviewCard\n        alt={urlData.name || \"\"}\n        className={layout === \"carousel\" ? \"aspect-video w-full\" : undefined}\n        onDownload={() => window.open(urlData.url, \"_blank\")}\n        onRemove={onRemove}\n        onView={() => onView(urlData.url, urlData.name || \"Preview\", \"image/*\")}\n        src={urlData.url}\n      />\n    );\n  }\n\n  const fileData = item.data as CompressedFileWithPreview;\n  const savings = (\n    ((fileData.originalSize - fileData.compressedSize) /\n      fileData.originalSize) *\n    100\n  ).toFixed(1);\n\n  return (\n    <ImagePreviewCard\n      alt={fileData.name}\n      className={layout === \"carousel\" ? \"aspect-video w-full\" : undefined}\n      onDownload={() => onDownload(fileData)}\n      onRemove={onRemove}\n      onView={\n        fileData.preview\n          ? () => onView(fileData.preview ?? \"\", fileData.name, fileData.type)\n          : undefined\n      }\n      src={fileData.preview || \"\"}\n    >\n      <div className=\"space-y-0.5\">\n        <p className=\"truncate font-medium text-[10px] text-white\">\n          {fileData.name}\n        </p>\n        <div className=\"flex justify-between text-[10px] text-white/80\">\n          <span>{formatBytes(fileData.compressedSize)}</span>\n          {showCompressionDetails && (\n            <Badge\n              className=\"text-xs\"\n              variant={Number.parseFloat(savings) > 0 ? \"default\" : \"secondary\"}\n            >\n              {Number.parseFloat(savings) > 0 ? `-${savings}%` : \"0%\"}\n            </Badge>\n          )}\n        </div>\n      </div>\n    </ImagePreviewCard>\n  );\n}\n\nasync function compressImageHelper(\n  file: File,\n  options: CompressionOptions,\n  // biome-ignore lint/suspicious/noExplicitAny: Dynamic import type is complex\n  browserImageCompression: any\n): Promise<CompressedFileWithPreview> {\n  if (!browserImageCompression) {\n    return Object.assign(file, {\n      originalSize: file.size,\n      compressedSize: file.size,\n      preview: URL.createObjectURL(file),\n    }) as CompressedFileWithPreview;\n  }\n\n  if (!file.type.startsWith(\"image/\")) {\n    return Object.assign(file, {\n      originalSize: file.size,\n      compressedSize: file.size,\n      preview: URL.createObjectURL(file),\n    }) as CompressedFileWithPreview;\n  }\n\n  try {\n    const opts = {\n      maxSizeMB: options.maxSizeMB,\n      maxWidthOrHeight: options.maxWidthOrHeight,\n      useWebWorker: options.useWebWorker,\n      alwaysKeepResolution: options.alwaysKeepResolution,\n    };\n    const blob = await browserImageCompression(file, opts);\n    const preview = URL.createObjectURL(blob);\n    const compressedFile = new window.File([blob], file.name, {\n      type: file.type,\n    }) as CompressedFileWithPreview;\n    compressedFile.originalSize = file.size;\n    compressedFile.compressedSize = compressedFile.size;\n    compressedFile.preview = preview;\n    return compressedFile;\n  } catch (e) {\n    console.error(\"Compression failed for\", file.name, e);\n    return Object.assign(file, {\n      originalSize: file.size,\n      compressedSize: file.size,\n      preview: URL.createObjectURL(file), // Fallback preview\n    }) as CompressedFileWithPreview;\n  }\n}\n"
      },
      "tags": [],
      "source": null
    },
    {
      "category": "format",
      "severity": "error",
      "description": "Formatter would have printed the following content:",
      "message": [
        {
          "elements": [],
          "content": "Formatter would have printed the following content:"
        }
      ],
      "advices": {
        "advices": [
          {
            "diff": {
              "dictionary": "\"use client\";\n\n\nimport {\n  Carousel,\n  CarouselContent,  // Handle crop complete\n  // biome-ignore lint/complexity/noExcessiveCognitiveComplexity: Complex logic\n  const handleCropComplete = React.useCallback(\n    (result: CropResult) => {\n      setProcessedCrops((prev) => [...prev, result]);  }\n}\n",
              "ops": [
                { "diffOp": { "equal": { "range": [0, 15] } } },
                { "diffOp": { "delete": { "range": [15, 16] } } },
                { "diffOp": { "equal": { "range": [16, 55] } } },
                { "equalLines": { "line_count": 592 } },
                { "diffOp": { "equal": { "range": [55, 208] } } },
                { "diffOp": { "delete": { "range": [15, 16] } } },
                { "diffOp": { "equal": { "range": [208, 292] } } },
                { "equalLines": { "line_count": 674 } },
                { "diffOp": { "equal": { "range": [292, 298] } } }
              ]
            }
          }
        ]
      },
      "verboseAdvices": { "advices": [] },
      "location": {
        "path": {
          "file": "packages\\ui\\src\\composed\\file-upload\\image-uploader.tsx"
        },
        "span": null,
        "sourceCode": "\"use client\";\n\n\nimport {\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselNext,\n  CarouselPrevious,\n} from \"@workspace/ui/components/carousel\";\nimport { cn } from \"@workspace/ui/lib/utils\";\n\nimport {\n  ChevronDown,\n  ChevronRight,\n  Crop,\n  Download,\n  Eye,\n  FileImage,\n  Loader2,\n  MoreVertical,\n  Plus,\n  Sparkles,\n  Upload,\n  X,\n} from \"lucide-react\";\nimport * as React from \"react\";\nimport { toast } from \"sonner\";\nimport { Badge } from \"../../components/badge\";\nimport { Button } from \"../../components/button\";\nimport { Checkbox } from \"../../components/checkbox\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"../../components/dropdown-menu\";\nimport { Label } from \"../../components/label\";\nimport { Slider } from \"../../components/slider\";\nimport { ConfirmDialog } from \"../confirm-dialog\"; // Import ConfirmDialog\nimport { FilePreviewDialog } from \"../file-preview/file-preview-dialog\";\nimport { DropzonePrimitive } from \"./dropzone-primitive\";\nimport { type CropResult, ImageCropDialog } from \"./image-crop-dialog\";\n\nexport interface CompressionOptions {\n  maxSizeMB: number;\n  maxWidthOrHeight: number;\n  useWebWorker: boolean;\n  alwaysKeepResolution: boolean;\n}\n\nexport interface CompressedFileWithPreview extends File {\n  originalSize: number;\n  compressedSize: number;\n  preview?: string;\n}\n\n/**\n * Pre-loaded image URL for edit mode display\n */\nexport interface InitialUrl {\n  id: string;\n  url: string;\n  name?: string;\n}\n\ntype CombinedItem =\n  | { type: \"url\"; id: string | number; data: InitialUrl }\n  | { type: \"file\"; id: string | number; data: CompressedFileWithPreview };\n\nexport interface ImageUploaderProps {\n  /**\n   * Callback when files are compressed\n   */\n  onCompressed?: (files: CompressedFileWithPreview[]) => void;\n\n  /**\n   * Callback when upload is requested/confirmed\n   */\n  onConfirm?: (files: CompressedFileWithPreview[]) => void;\n\n  /**\n   * Default compression options\n   */\n  defaultOptions?: Partial<CompressionOptions>;\n\n  /**\n   * Show upload/confirm button after compression\n   */\n  showConfirmButton?: boolean;\n  /**\n   * Show compression options UI\n   * @default false\n   */\n  showCompressionOptions?: boolean;\n\n  /**\n   * Enable cropping by default\n   * @default false\n   */\n  enableCropping?: boolean;\n\n  /**\n   * Automatically upload after compression (if cropping is disabled)\n   * @default false\n   */\n  autoUpload?: boolean;\n\n  /**\n   * Is currently uploading\n   */\n  isUploading?: boolean;\n\n  className?: string;\n  showCompressionDetails?: boolean;\n  /**\n   * Pre-loaded image URLs for edit mode (display-only with remove)\n   */\n  initialUrls?: InitialUrl[];\n\n  /**\n   * Callback when a pre-loaded URL is removed\n   */\n  onRemoveUrl?: (id: string) => void;\n\n  /**\n   * Layout mode for displaying images\n   * @default \"grid\"\n   */\n  layout?: \"grid\" | \"carousel\";\n}\n\n// Format bytes to human readable\nfunction formatBytes(bytes: number): string {\n  if (bytes === 0) {\n    return \"0 B\";\n  }\n  const k = 1024;\n  const sizes = [\"B\", \"KB\", \"MB\", \"GB\"];\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n  return `${Number.parseFloat((bytes / k ** i).toFixed(1))} ${sizes[i]}`;\n}\n\nexport interface ImageUploaderRef {\n  addFiles: (files: File[]) => void;\n  clearFiles: () => void;\n}\n\ninterface CompressionOptionsPanelProps {\n  isOpen: boolean;\n  onOpenChange: (open: boolean) => void;\n  enableCropping: boolean;\n  onEnableCroppingChange: (enabled: boolean) => void;\n  options: CompressionOptions;\n  onOptionsChange: (options: CompressionOptions) => void;\n}\n\nfunction CompressionOptionsPanel({\n  isOpen,\n  onOpenChange,\n  enableCropping,\n  onEnableCroppingChange,\n  options,\n  onOptionsChange,\n}: CompressionOptionsPanelProps) {\n  return (\n    <div className=\"rounded-lg border bg-muted/30 p-4\">\n      <button\n        className=\"flex w-full items-center justify-between font-medium text-sm\"\n        onClick={() => onOpenChange(!isOpen)}\n        type=\"button\"\n      >\n        <span>Compression Options</span>\n        {isOpen ? (\n          <ChevronDown className=\"h-4 w-4\" />\n        ) : (\n          <ChevronRight className=\"h-4 w-4\" />\n        )}\n      </button>\n\n      {isOpen && (\n        <div className=\"mt-4 space-y-4\">\n          {/* Enable cropping toggle */}\n          <div className=\"flex items-center gap-3 rounded-lg border border-primary/20 bg-primary/5 p-3\">\n            <Sparkles className=\"h-5 w-5 text-primary\" />\n            <div className=\"flex flex-1 flex-col gap-1\">\n              <Label className=\"cursor-pointer\" htmlFor=\"enable-cropping\">\n                Enable image cropping\n              </Label>\n              <p className=\"text-muted-foreground text-xs\">\n                Crop, rotate, and flip images before compression\n              </p>\n            </div>\n            <Checkbox\n              checked={enableCropping}\n              id=\"enable-cropping\"\n              onCheckedChange={(checked: boolean) =>\n                onEnableCroppingChange(checked)\n              }\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center justify-between\">\n              <Label htmlFor=\"maxSizeMB\">Max file size (MB)</Label>\n              <span className=\"text-muted-foreground text-sm\">\n                {options.maxSizeMB} MB\n              </span>\n            </div>\n            <Slider\n              id=\"maxSizeMB\"\n              max={10}\n              min={0.1}\n              onValueChange={([value]: number[]) => {\n                if (value !== undefined) {\n                  onOptionsChange({\n                    ...options,\n                    maxSizeMB: value,\n                  });\n                }\n              }}\n              step={0.1}\n              value={[options.maxSizeMB]}\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center justify-between\">\n              <Label htmlFor=\"maxDimension\">Max width/height (px)</Label>\n              <span className=\"text-muted-foreground text-sm\">\n                {options.maxWidthOrHeight} px\n              </span>\n            </div>\n            <Slider\n              id=\"maxDimension\"\n              max={4096}\n              min={480}\n              onValueChange={([value]: number[]) => {\n                if (value !== undefined) {\n                  onOptionsChange({\n                    ...options,\n                    maxWidthOrHeight: value,\n                  });\n                }\n              }}\n              step={32}\n              value={[options.maxWidthOrHeight]}\n            />\n          </div>\n\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center gap-3\">\n              <Checkbox\n                checked={options.useWebWorker}\n                onCheckedChange={(checked: boolean) =>\n                  onOptionsChange({\n                    ...options,\n                    useWebWorker: checked,\n                  })\n                }\n              />\n              <Label className=\"cursor-pointer\">Use Web Worker</Label>\n            </div>\n\n            <div className=\"flex items-center gap-3\">\n              <Checkbox\n                checked={options.alwaysKeepResolution}\n                onCheckedChange={(checked: boolean) =>\n                  onOptionsChange({\n                    ...options,\n                    alwaysKeepResolution: checked,\n                  })\n                }\n              />\n              <Label className=\"cursor-pointer\">Keep resolution</Label>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\ninterface ImageGridListProps {\n  items: CombinedItem[];\n  layout: \"grid\" | \"carousel\";\n  onRemove: (item: CombinedItem) => void;\n  onDownload: (file: CompressedFileWithPreview) => void;\n  onView: (url: string, name: string, type: string) => void;\n  showCompressionDetails: boolean;\n}\n\nfunction ImageGridList({\n  items,\n  layout,\n  onRemove,\n  onDownload,\n  onView,\n  showCompressionDetails,\n}: ImageGridListProps) {\n  const renderItem = (item: CombinedItem) => (\n    <ImageUploaderItem\n      item={item}\n      key={item.id}\n      layout={layout}\n      onDownload={onDownload}\n      onRemove={() => onRemove(item)}\n      onView={onView}\n      showCompressionDetails={showCompressionDetails}\n    />\n  );\n\n  if (layout === \"grid\") {\n    return (\n      <div className=\"grid grid-cols-3 gap-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6\">\n        {items.map((item) => renderItem(item))}\n      </div>\n    );\n  }\n\n  return (\n    <Carousel\n      className=\"mx-auto min-h-[120px] w-full\"\n      opts={{ align: \"start\" }}\n    >\n      <CarouselContent className=\"-ml-2 md:-ml-4\">\n        {items.map((item) => (\n          <CarouselItem className=\"basis-full pl-2 md:pl-4\" key={item.id}>\n            {renderItem(item)}\n          </CarouselItem>\n        ))}\n      </CarouselContent>\n      <CarouselPrevious className=\"left-2 bg-background/80 hover:bg-background\" />\n      <CarouselNext className=\"right-2 bg-background/80 hover:bg-background\" />\n    </Carousel>\n  );\n}\n\nfunction useDragDrop(\n  onFilesSelected: (files: FileList | File[] | null) => void\n) {\n  const [isDragging, setIsDragging] = React.useState(false);\n\n  const handleDragOver = React.useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(true);\n  }, []);\n\n  const handleDragLeave = React.useCallback(() => {\n    setIsDragging(false);\n  }, []);\n\n  const handleDrop = React.useCallback(\n    (e: React.DragEvent) => {\n      e.preventDefault();\n      setIsDragging(false);\n      onFilesSelected(e.dataTransfer.files);\n    },\n    [onFilesSelected]\n  );\n\n  return { isDragging, handleDragOver, handleDragLeave, handleDrop };\n}\n\n// biome-ignore lint/complexity/noExcessiveCognitiveComplexity: Controller manages complex file upload state and workflows\nfunction useImageUploaderController(\n  props: ImageUploaderProps,\n  ref: React.ForwardedRef<ImageUploaderRef>\n) {\n  const {\n    onCompressed,\n    onConfirm,\n    defaultOptions,\n    enableCropping: defaultEnableCropping = false,\n    autoUpload = true,\n    initialUrls,\n  } = props;\n\n  const fileInputRef = React.useRef<HTMLInputElement>(null);\n  const [deleteTarget, setDeleteTarget] = React.useState<{\n    type: \"file\" | \"url\";\n    id: string | number;\n  } | null>(null);\n  const [_sourceFiles, setSourceFiles] = React.useState<File[]>([]);\n  const [compressedFiles, setCompressedFiles] = React.useState<\n    CompressedFileWithPreview[]\n  >([]);\n  const [isCompressing, setIsCompressing] = React.useState(false);\n\n  const [isCompressionOptionsOpen, setIsCompressionOptionsOpen] =\n    React.useState(false);\n  const [compressionOptions, setCompressionOptions] =\n    React.useState<CompressionOptions>({\n      maxSizeMB: defaultOptions?.maxSizeMB ?? 1,\n      maxWidthOrHeight: defaultOptions?.maxWidthOrHeight ?? 1920,\n      useWebWorker: defaultOptions?.useWebWorker ?? true,\n      alwaysKeepResolution: defaultOptions?.alwaysKeepResolution ?? false,\n    });\n\n  // Cropping state\n  const [enableCropping, setEnableCropping] = React.useState(\n    defaultEnableCropping\n  );\n  const [cropDialogOpen, setCropDialogOpen] = React.useState(false);\n  const [fileToCrop, setFileToCrop] = React.useState<File | null>(null);\n  const [cropQueue, setCropQueue] = React.useState<File[]>([]);\n  const [processedCrops, setProcessedCrops] = React.useState<CropResult[]>([]);\n\n  // Preview state\n  const [previewOpen, setPreviewOpen] = React.useState(false);\n  const [previewUrl, setPreviewUrl] = React.useState(\"\");\n  const [previewName, setPreviewName] = React.useState(\"\");\n  const [previewType, setPreviewType] = React.useState(\"\");\n\n  // Dynamically import browser-image-compression to avoid SSR issues\n  const [browserImageCompression, setBrowserImageCompression] = React.useState<\n    typeof import(\"browser-image-compression\").default | null\n  >(null);\n\n  React.useEffect(() => {\n    setEnableCropping(defaultEnableCropping);\n  }, [defaultEnableCropping]);\n\n  React.useEffect(() => {\n    import(\"browser-image-compression\").then((module) => {\n      setBrowserImageCompression(() => module.default);\n    });\n  }, []);\n\n  // Compress a single file\n  const compressSingleFile = React.useCallback(\n    (file: File) => {\n      return compressImageHelper(\n        file,\n        compressionOptions,\n        browserImageCompression\n      );\n    },\n    [browserImageCompression, compressionOptions]\n  );\n\n  // Handle file selection\n  const handleFileSelect = React.useCallback(\n    // biome-ignore lint/complexity/noExcessiveCognitiveComplexity: File selection validation logic is inherently complex\n    (files: FileList | File[] | null, skipCrop = false) => {\n      if (!files) {\n        return;\n      }\n\n      const newFiles = Array.from(files).filter((f) =>\n        f.type.startsWith(\"image/\")\n      );\n\n      if (newFiles.length === 0) {\n        toast.error(\"Please select image files only\");\n        return;\n      }\n\n      if (enableCropping && !skipCrop) {\n        // Add to queue for cropping\n        setCropQueue((prev) => {\n          const existing = prev.map((f) => f.name);\n          const filtered = newFiles.filter((f) => !existing.includes(f.name));\n          return [...prev, ...filtered];\n        });\n\n        // Start cropping if dialog is closed\n        if (!cropDialogOpen && newFiles.length > 0) {\n          setFileToCrop(newFiles[0] ?? null);\n          setCropDialogOpen(true);\n        }\n      } else {\n        // Auto-compress immediately\n        setSourceFiles((prev) => {\n          const existing = prev.map((f) => f.name);\n          const filtered = newFiles.filter((f) => !existing.includes(f.name));\n          return [...prev, ...filtered];\n        });\n\n        if (newFiles.length > 0) {\n          setIsCompressing(true);\n          Promise.all(newFiles.map((file) => compressSingleFile(file)))\n            .then((compressed) => {\n              setCompressedFiles((prev) => {\n                const existingNames = prev.map((f) => f.name);\n                const newCompressed = compressed.filter(\n                  (f) => !existingNames.includes(f.name)\n                );\n\n                const nextFiles = [...prev, ...newCompressed];\n                return nextFiles;\n              });\n\n              if (autoUpload && (!enableCropping || skipCrop)) {\n                setTimeout(() => {\n                  setCompressedFiles((current) => {\n                    onConfirm?.(current);\n                    return current;\n                  });\n                }, 0);\n              }\n\n              const totalOriginal = compressed.reduce(\n                (acc, f) => acc + f.originalSize,\n                0\n              );\n              const totalCompressed = compressed.reduce(\n                (acc, f) => acc + f.compressedSize,\n                0\n              );\n              const saving =\n                ((totalOriginal - totalCompressed) / totalOriginal) * 100;\n\n              toast.success(\n                `Compressed ${compressed.length} image${compressed.length > 1 ? \"s\" : \"\"} - Saved ${saving.toFixed(1)}%`\n              );\n\n              onCompressed?.(compressed);\n            })\n            .catch(() => {\n              toast.error(\"Compression failed\");\n            })\n            .finally(() => {\n              setIsCompressing(false);\n            });\n        }\n      }\n    },\n    [\n      compressSingleFile,\n      cropDialogOpen,\n      enableCropping,\n      onCompressed,\n      autoUpload,\n      onConfirm,\n    ]\n  );\n\n  // biome-ignore lint/complexity/noExcessiveCognitiveComplexity: Complex logic\n  const compressAndUploadCrops = React.useCallback(\n    (allCrops: CropResult[]) => {\n      setIsCompressing(true);\n\n      Promise.all(\n        allCrops.map((cropResult) => {\n          const cropFile = new File([cropResult.blob], cropResult.file.name, {\n            type: cropResult.file.type,\n          });\n          return compressSingleFile(cropFile);\n        })\n      )\n        .then((compressed) => {\n          setCompressedFiles((prev) => {\n            const existingNames = prev.map((f) => f.name);\n            const newCompressed = compressed.filter(\n              (f) => !existingNames.includes(f.name)\n            );\n            return [...prev, ...newCompressed];\n          });\n\n          if (autoUpload) {\n            setTimeout(() => {\n              setCompressedFiles((current) => {\n                onConfirm?.(current);\n                return current;\n              });\n            }, 0);\n          }\n\n          setProcessedCrops([]);\n\n          const totalOriginal = compressed.reduce(\n            (acc, f) => acc + f.originalSize,\n            0\n          );\n          const totalCompressed = compressed.reduce(\n            (acc, f) => acc + f.compressedSize,\n            0\n          );\n          const saving =\n            ((totalOriginal - totalCompressed) / totalOriginal) * 100;\n\n          toast.success(\n            `Processed ${compressed.length} image${compressed.length > 1 ? \"s\" : \"\"} - Saved ${saving.toFixed(1)}%`\n          );\n\n          onCompressed?.(compressed);\n        })\n        .catch(() => {\n          toast.error(\"Compression failed\");\n        })\n        .finally(() => {\n          setIsCompressing(false);\n        });\n    },\n    [compressSingleFile, autoUpload, onConfirm, onCompressed]\n  );\n\n  // Handle crop complete\n  // biome-ignore lint/complexity/noExcessiveCognitiveComplexity: Complex logic\n  const handleCropComplete = React.useCallback(\n\n    (result: CropResult) => {\n      setProcessedCrops((prev) => [...prev, result]);\n      setCropQueue((prev) => prev.filter((f) => f.name !== result.file.name));\n\n      // Process next in queue\n      const remaining = cropQueue.filter((f) => f.name !== result.file.name);\n      if (remaining.length > 0) {\n        setFileToCrop(remaining[0] ?? null);\n        return;\n      }\n\n      setFileToCrop(null);\n      setCropDialogOpen(false);\n\n      // All images cropped, now compress\n      const allCrops = [...processedCrops, result];\n      compressAndUploadCrops(allCrops);\n    },\n    [cropQueue, processedCrops, compressAndUploadCrops]\n  );\n\n  // Handle skip crop\n  const handleSkipCrop = React.useCallback(() => {\n    if (!fileToCrop) {\n      return;\n    }\n\n    // Skip this file and move to next\n    setCropQueue((prev) => prev.filter((f) => f.name !== fileToCrop.name));\n\n    const remaining = cropQueue.filter((f) => f.name !== fileToCrop.name);\n    if (remaining.length > 0) {\n      setFileToCrop(remaining[0] ?? null);\n    } else {\n      setFileToCrop(null);\n      setCropDialogOpen(false);\n    }\n  }, [cropQueue, fileToCrop]);\n\n  // Remove compressed file\n  const removeCompressedFile = React.useCallback((index: number) => {\n    setCompressedFiles((prev) => {\n      const file = prev[index];\n      if (file?.preview) {\n        URL.revokeObjectURL(file.preview);\n      }\n      return prev.filter((_, idx) => idx !== index);\n    });\n  }, []);\n\n  // Download compressed file\n  const downloadFile = React.useCallback((file: CompressedFileWithPreview) => {\n    if (file.preview) {\n      const link = document.createElement(\"a\");\n      link.href = file.preview;\n      link.download = file.name;\n      link.click();\n    }\n  }, []);\n\n  // Clear all\n  const clearAll = React.useCallback(() => {\n    for (const f of compressedFiles) {\n      if (f.preview) {\n        URL.revokeObjectURL(f.preview);\n      }\n    }\n    for (const f of processedCrops) {\n      URL.revokeObjectURL(f.url);\n    }\n    setSourceFiles([]);\n    setCompressedFiles([]);\n    setCropQueue([]);\n    setProcessedCrops([]);\n  }, [compressedFiles, processedCrops]);\n\n  React.useImperativeHandle(ref, () => ({\n    addFiles: (files: File[]) => handleFileSelect(files, true),\n    clearFiles: clearAll,\n  }));\n\n  const { isDragging, handleDragOver, handleDragLeave, handleDrop } =\n    useDragDrop(handleFileSelect);\n\n  // Cleanup previews on unmount\n  React.useEffect(() => {\n    return () => {\n      for (const f of compressedFiles) {\n        if (f.preview) {\n          URL.revokeObjectURL(f.preview);\n        }\n      }\n      for (const f of processedCrops) {\n        URL.revokeObjectURL(f.url);\n      }\n    };\n  }, [compressedFiles, processedCrops]);\n\n  const hasFilesInQueue = cropQueue.length > 0 || processedCrops.length > 0;\n  const totalInQueue = cropQueue.length + processedCrops.length;\n  const hasInitialUrls = initialUrls && initialUrls.length > 0;\n  const hasAnyFiles =\n    compressedFiles.length > 0 || hasFilesInQueue || hasInitialUrls;\n\n  const combinedItems = React.useMemo<CombinedItem[]>(\n    () => [\n      ...(initialUrls || []).map((url) => ({\n        type: \"url\" as const,\n        id: url.id,\n        data: url,\n      })),\n      ...compressedFiles.map((file, index) => ({\n        type: \"file\" as const,\n        id: file.name || index,\n        data: file,\n      })),\n    ],\n    [initialUrls, compressedFiles]\n  );\n\n  return {\n    fileInputRef,\n    deleteTarget,\n    setDeleteTarget,\n    compressedFiles,\n    isCompressing,\n    isDragging,\n    isCompressionOptionsOpen,\n    setIsCompressionOptionsOpen,\n    compressionOptions,\n    setCompressionOptions,\n    enableCropping,\n    setEnableCropping,\n    cropDialogOpen,\n    setCropDialogOpen,\n    fileToCrop,\n    setFileToCrop,\n    cropQueue,\n    processedCrops,\n    previewOpen,\n    setPreviewOpen,\n    previewUrl,\n    setPreviewUrl,\n    previewName,\n    setPreviewName,\n    previewType,\n    setPreviewType,\n    handleFileSelect,\n    handleCropComplete,\n    handleSkipCrop,\n    removeCompressedFile,\n    downloadFile,\n    clearAll,\n    handleDragOver,\n    handleDragLeave,\n    handleDrop,\n    hasFilesInQueue,\n    totalInQueue,\n    hasInitialUrls,\n    hasAnyFiles,\n    combinedItems,\n  };\n}\n\nexport const ImageUploader = React.forwardRef<\n  ImageUploaderRef,\n  ImageUploaderProps\n>((props, ref) => {\n  const {\n    className,\n    showCompressionOptions = false,\n    showCompressionDetails = false,\n    showConfirmButton = true,\n    onConfirm,\n    isUploading = false,\n    initialUrls,\n    onRemoveUrl,\n    layout = \"grid\",\n  } = props;\n\n  const controller = useImageUploaderController(props, ref);\n\n  return (\n    <div className={cn(\"space-y-4\", className)}>\n      {/* Options */}\n      {showCompressionOptions && (\n        <CompressionOptionsPanel\n          enableCropping={controller.enableCropping}\n          isOpen={controller.isCompressionOptionsOpen}\n          onEnableCroppingChange={controller.setEnableCropping}\n          onOpenChange={controller.setIsCompressionOptionsOpen}\n          onOptionsChange={controller.setCompressionOptions}\n          options={controller.compressionOptions}\n        />\n      )}\n\n      {/* File Preview Dialog */}\n      <FilePreviewDialog\n        fileName={controller.previewName}\n        fileType={controller.previewType}\n        fileUrl={controller.previewUrl}\n        onOpenChange={controller.setPreviewOpen}\n        open={controller.previewOpen}\n      />\n\n      {/* Upload Area */}\n      {controller.hasAnyFiles ? (\n        <div className=\"space-y-3\">\n          {/* Crop queue indicator */}\n          {controller.hasFilesInQueue && (\n            <div className=\"flex items-center gap-3 rounded-lg border border-primary/20 bg-primary/5 p-3\">\n              <Crop className=\"h-5 w-5 animate-pulse text-primary\" />\n              <div className=\"flex flex-1 flex-col\">\n                <p className=\"font-medium text-sm\">\n                  Processing {controller.totalInQueue} image\n                  {controller.totalInQueue > 1 ? \"s\" : \"\"}\n                </p>\n                <p className=\"text-muted-foreground text-xs\">\n                  {controller.processedCrops.length} of{\" \"}\n                  {controller.totalInQueue} cropped\n                </p>\n              </div>\n              <Loader2 className=\"h-5 w-5 animate-spin text-primary\" />\n            </div>\n          )}\n\n          {/* Add more files button */}\n          <DropzonePrimitive\n            className=\"py-2\"\n            compact={true}\n            onClick={() => {\n              controller.fileInputRef.current?.click();\n            }}\n            onDragLeave={controller.handleDragLeave}\n            onDragOver={controller.handleDragOver}\n            onDrop={controller.handleDrop}\n            onKeyDown={(e) => {\n              if (e.key === \"Enter\" || e.key === \" \") {\n                e.preventDefault();\n                controller.fileInputRef.current?.click();\n              }\n            }}\n          >\n            <Plus className=\"mr-2 h-4 w-4\" />\n            Add more images\n            <input\n              accept=\"image/*\"\n              className=\"hidden\"\n              multiple\n              onChange={(e) => controller.handleFileSelect(e.target.files)}\n              ref={controller.fileInputRef}\n              type=\"file\"\n            />\n          </DropzonePrimitive>\n\n          {/* Images list (Unified) */}\n          {controller.hasAnyFiles &&\n            (controller.compressedFiles.length > 0 ||\n              controller.hasInitialUrls) && (\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between\">\n                  <h3 className=\"font-medium text-sm\">\n                    Images (\n                    {(initialUrls?.length || 0) +\n                      controller.compressedFiles.length}\n                    )\n                  </h3>\n                  {controller.compressedFiles.length > 0 && (\n                    <Button\n                      className=\"text-muted-foreground text-xs\"\n                      disabled={controller.isCompressing}\n                      onClick={controller.clearAll}\n                      size=\"sm\"\n                      variant=\"ghost\"\n                    >\n                      Clear new\n                    </Button>\n                  )}\n                </div>\n                <ImageGridList\n                  items={controller.combinedItems}\n                  layout={layout}\n                  onDownload={controller.downloadFile}\n                  onRemove={(item) => {\n                    if (item.type === \"url\") {\n                      controller.setDeleteTarget({\n                        type: \"url\",\n                        id: item.id,\n                      });\n                    } else {\n                      // Find index in compressedFiles\n                      const index = controller.compressedFiles.indexOf(\n                        item.data as CompressedFileWithPreview\n                      );\n                      controller.setDeleteTarget({\n                        type: \"file\",\n                        id: index,\n                      });\n                    }\n                  }}\n                  onView={(url, name, type) => {\n                    controller.setPreviewUrl(url);\n                    controller.setPreviewName(name);\n                    controller.setPreviewType(type);\n                    controller.setPreviewOpen(true);\n                  }}\n                  showCompressionDetails={showCompressionDetails}\n                />\n              </div>\n            )}\n\n          {/* Loading state */}\n          {controller.isCompressing && (\n            <div className=\"flex items-center justify-center gap-2 rounded-lg border bg-muted/30 py-4 text-muted-foreground text-sm\">\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\n              Processing images...\n            </div>\n          )}\n\n          {/* Confirm Button */}\n          {showConfirmButton &&\n            onConfirm &&\n            controller.compressedFiles.length > 0 && (\n              <Button\n                className=\"w-full\"\n                disabled={isUploading || controller.isCompressing}\n                onClick={() => onConfirm(controller.compressedFiles)}\n              >\n                {isUploading ? (\n                  <>\n                    <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                    Uploading...\n                  </>\n                ) : (\n                  <>\n                    <Upload className=\"mr-2 h-4 w-4\" />\n                    Confirm Upload ({controller.compressedFiles.length})\n                  </>\n                )}\n              </Button>\n            )}\n        </div>\n      ) : (\n        <DropzonePrimitive\n          className={cn(\n            \"gap-4\",\n            controller.isDragging\n              ? \"border-primary bg-primary/5\"\n              : \"border-muted-foreground/25 hover:border-primary/50 hover:bg-muted/50\"\n          )}\n          compact={false}\n          onClick={() => {\n            controller.fileInputRef.current?.click();\n          }}\n          onDragLeave={controller.handleDragLeave}\n          onDragOver={controller.handleDragOver}\n          onDrop={controller.handleDrop}\n          onKeyDown={(e) => {\n            if (e.key === \"Enter\" || e.key === \" \") {\n              e.preventDefault();\n              controller.fileInputRef.current?.click();\n            }\n          }}\n        >\n          <FileImage className=\"h-10 w-10 text-muted-foreground\" />\n          <div className=\"space-y-1 text-center sm:text-left\">\n            <p className=\"font-medium text-lg\">Drop images here</p>\n            <p className=\"text-muted-foreground text-sm\">or click to browse</p>\n          </div>\n          <input\n            accept=\"image/*\"\n            className=\"hidden\"\n            multiple\n            onChange={(e) => controller.handleFileSelect(e.target.files)}\n            ref={controller.fileInputRef}\n            type=\"file\"\n          />\n        </DropzonePrimitive>\n      )}\n\n      {/* Crop Dialog */}\n      <ImageCropDialog\n        imageFile={controller.fileToCrop}\n        onCropComplete={controller.handleCropComplete}\n        onOpenChange={(open: boolean) => {\n          if (open) {\n            controller.setCropDialogOpen(open);\n          } else {\n            controller.handleSkipCrop();\n          }\n        }}\n        onSelectFile={controller.setFileToCrop}\n        open={controller.cropDialogOpen}\n        queue={controller.cropQueue}\n      />\n\n      <ConfirmDialog\n        description=\"This action cannot be undone.\"\n        onCancel={() => controller.setDeleteTarget(null)}\n        onConfirm={() => {\n          if (controller.deleteTarget?.type === \"file\") {\n            controller.removeCompressedFile(\n              controller.deleteTarget.id as number\n            );\n          } else if (controller.deleteTarget?.type === \"url\") {\n            onRemoveUrl?.(controller.deleteTarget.id as string);\n          }\n          controller.setDeleteTarget(null);\n        }}\n        onOpenChange={(open) => !open && controller.setDeleteTarget(null)}\n        open={!!controller.deleteTarget}\n        title=\"Are you sure?\"\n        variant=\"destructive\"\n      />\n    </div>\n  );\n});\ninterface ImagePreviewCardProps {\n  src: string;\n  alt: string;\n  onView?: () => void;\n  onDownload?: () => void;\n  onRemove?: () => void;\n  children?: React.ReactNode;\n  className?: string;\n}\n\nfunction ImagePreviewCard({\n  src,\n  alt,\n  onView,\n  onDownload,\n  onRemove,\n  children,\n  className,\n}: ImagePreviewCardProps) {\n  const containerRef = React.useRef<HTMLDivElement>(null);\n  const [width, setWidth] = React.useState(0);\n\n  React.useEffect(() => {\n    if (!containerRef.current) {\n      return;\n    }\n    const observer = new ResizeObserver((entries) => {\n      for (const entry of entries) {\n        setWidth(entry.contentRect.width);\n      }\n    });\n    observer.observe(containerRef.current);\n    return () => observer.disconnect();\n  }, []);\n\n  const isSmall = width < 100;\n\n  return (\n    <div\n      className={cn(\n        \"group relative aspect-square overflow-hidden rounded-lg border bg-card\",\n        className\n      )}\n      ref={containerRef}\n    >\n      {/* Thumbnail */}\n      {src ? (\n        // biome-ignore lint/correctness/useImageSize: Dynamic content\n        // biome-ignore lint/performance/noImgElement: Framework-agnostic\n        <img alt={alt} className=\"size-full object-cover\" src={src} />\n      ) : (\n        <div className=\"flex size-full items-center justify-center bg-muted\">\n          <FileImage className=\"h-8 w-8 text-muted-foreground\" />\n        </div>\n      )}\n\n      {/* Overlay on hover */}\n      <div className=\"absolute inset-0 flex flex-col justify-between bg-black/60 p-2 opacity-0 transition-opacity group-hover:opacity-100 data-[state=open]:opacity-100\">\n        {/* Actions at top */}\n        <div className=\"flex justify-end\">\n          {isSmall ? (\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button\n                  className=\"size-6 p-0 text-white hover:bg-white/20 hover:text-white\"\n                  size=\"icon\"\n                  variant=\"ghost\"\n                >\n                  <MoreVertical className=\"size-4\" />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                {onView && (\n                  <DropdownMenuItem onClick={onView}>\n                    <Eye className=\"mr-2 size-4\" /> View\n                  </DropdownMenuItem>\n                )}\n                {onDownload && (\n                  <DropdownMenuItem onClick={onDownload}>\n                    <Download className=\"mr-2 size-4\" /> Download\n                  </DropdownMenuItem>\n                )}\n                {onRemove && (\n                  <DropdownMenuItem\n                    className=\"text-destructive focus:text-destructive\"\n                    onClick={onRemove}\n                  >\n                    <X className=\"mr-2 size-4\" /> Remove\n                  </DropdownMenuItem>\n                )}\n              </DropdownMenuContent>\n            </DropdownMenu>\n          ) : (\n            <div className=\"flex justify-end gap-0.5\">\n              {onView && (\n                <Button\n                  className=\"size-6.5 p-0\"\n                  onClick={onView}\n                  size=\"icon\"\n                  title=\"View\"\n                  variant=\"secondary\"\n                >\n                  <Eye className=\"size-3.5\" />\n                </Button>\n              )}\n              {onDownload && (\n                <Button\n                  className=\"size-6.5 p-0\"\n                  onClick={onDownload}\n                  size=\"icon\"\n                  title=\"Download\"\n                  variant=\"secondary\"\n                >\n                  <Download className=\"size-3.5\" />\n                </Button>\n              )}\n              {onRemove && (\n                <Button\n                  className=\"size-6.5 p-0\"\n                  onClick={onRemove}\n                  size=\"icon\"\n                  title=\"Remove\"\n                  variant=\"destructive\"\n                >\n                  <X className=\"size-3.5\" />\n                </Button>\n              )}\n            </div>\n          )}\n        </div>\n\n        {/* File info at bottom */}\n        {children}\n      </div>\n\n      {/* Filename visible at bottom when not hovering/open */}\n      <div className=\"absolute right-0 bottom-0 left-0 rounded-b-lg bg-gradient-to-t from-black/70 to-transparent p-2 opacity-100 transition-opacity group-hover:opacity-0\">\n        <p className=\"truncate font-medium text-white text-xs\" title={alt}>\n          {alt}\n        </p>\n      </div>\n    </div>\n  );\n}\n\nfunction ImageUploaderItem({\n  item,\n  layout,\n  onDownload,\n  onRemove,\n  onView,\n  showCompressionDetails,\n}: {\n  item: CombinedItem;\n  layout: \"grid\" | \"carousel\";\n  onDownload: (file: CompressedFileWithPreview) => void;\n  onRemove: () => void;\n  onView: (url: string, name: string, type: string) => void;\n  showCompressionDetails: boolean;\n}) {\n  if (item.type === \"url\") {\n    const urlData = item.data as InitialUrl;\n    return (\n      <ImagePreviewCard\n        alt={urlData.name || \"\"}\n        className={layout === \"carousel\" ? \"aspect-video w-full\" : undefined}\n        onDownload={() => window.open(urlData.url, \"_blank\")}\n        onRemove={onRemove}\n        onView={() => onView(urlData.url, urlData.name || \"Preview\", \"image/*\")}\n        src={urlData.url}\n      />\n    );\n  }\n\n  const fileData = item.data as CompressedFileWithPreview;\n  const savings = (\n    ((fileData.originalSize - fileData.compressedSize) /\n      fileData.originalSize) *\n    100\n  ).toFixed(1);\n\n  return (\n    <ImagePreviewCard\n      alt={fileData.name}\n      className={layout === \"carousel\" ? \"aspect-video w-full\" : undefined}\n      onDownload={() => onDownload(fileData)}\n      onRemove={onRemove}\n      onView={\n        fileData.preview\n          ? () => onView(fileData.preview ?? \"\", fileData.name, fileData.type)\n          : undefined\n      }\n      src={fileData.preview || \"\"}\n    >\n      <div className=\"space-y-0.5\">\n        <p className=\"truncate font-medium text-[10px] text-white\">\n          {fileData.name}\n        </p>\n        <div className=\"flex justify-between text-[10px] text-white/80\">\n          <span>{formatBytes(fileData.compressedSize)}</span>\n          {showCompressionDetails && (\n            <Badge\n              className=\"text-xs\"\n              variant={Number.parseFloat(savings) > 0 ? \"default\" : \"secondary\"}\n            >\n              {Number.parseFloat(savings) > 0 ? `-${savings}%` : \"0%\"}\n            </Badge>\n          )}\n        </div>\n      </div>\n    </ImagePreviewCard>\n  );\n}\n\nasync function compressImageHelper(\n  file: File,\n  options: CompressionOptions,\n  // biome-ignore lint/suspicious/noExplicitAny: Dynamic import type is complex\n  browserImageCompression: any\n): Promise<CompressedFileWithPreview> {\n  if (!browserImageCompression) {\n    return Object.assign(file, {\n      originalSize: file.size,\n      compressedSize: file.size,\n      preview: URL.createObjectURL(file),\n    }) as CompressedFileWithPreview;\n  }\n\n  if (!file.type.startsWith(\"image/\")) {\n    return Object.assign(file, {\n      originalSize: file.size,\n      compressedSize: file.size,\n      preview: URL.createObjectURL(file),\n    }) as CompressedFileWithPreview;\n  }\n\n  try {\n    const opts = {\n      maxSizeMB: options.maxSizeMB,\n      maxWidthOrHeight: options.maxWidthOrHeight,\n      useWebWorker: options.useWebWorker,\n      alwaysKeepResolution: options.alwaysKeepResolution,\n    };\n    const blob = await browserImageCompression(file, opts);\n    const preview = URL.createObjectURL(blob);\n    const compressedFile = new window.File([blob], file.name, {\n      type: file.type,\n    }) as CompressedFileWithPreview;\n    compressedFile.originalSize = file.size;\n    compressedFile.compressedSize = compressedFile.size;\n    compressedFile.preview = preview;\n    return compressedFile;\n  } catch (e) {\n    console.error(\"Compression failed for\", file.name, e);\n    return Object.assign(file, {\n      originalSize: file.size,\n      compressedSize: file.size,\n      preview: URL.createObjectURL(file), // Fallback preview\n    }) as CompressedFileWithPreview;\n  }\n}\n"
      },
      "tags": [],
      "source": null
    }
  ],
  "command": "check"
}
